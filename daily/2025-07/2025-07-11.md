※スクール内timesの移植（2025/09/28）

うーん、ransackのsort_linkつかわないで送られてきたパラメーターでソートする方が楽だな！  
ransack、AND検索が思うような実装にならなかった時点で自前で検索機能構築したほうがよかったなあという思い。  
まあ…いいけどさ…  

counter_cache…ふむふむ…  
counter_cache使えるとこでは使っていった方がいいなこれ  
おそらく  
counter_cache使ったらすぐソート実装できたから小難しく考えすぎてたわ

- 学習時間：4h/20h30min/1080h
- 学習内容：いいね順ソート実装

ransackのソート機能使ってソートするのやめました。  
ransackにわたすパラメーターの構造を考えて、どうにかransackのソート機能を使えないか…としていましたが、なんだが複雑だし自分でもよくわからん！になったのでやめました。  
以前、[複数の検索ワードでのAND検索](https://chat.runteq.jp/runteq/pl/csia3gt17j8z3pokfp4ag4feww)を実装したときに、ransackのシンプルモードでのAND検索だと思ってるようなクエリにならなかったので、アドバンストモードのgroupingを使って実装したのですが、自分の実装とransackのソート機能を両立させるのはどうも難しいようです。  
`s:`の位置を色々変えてみたりしたのですが…どうにも動かず…。  
シンプルにやろう、ということで、`order`の引数を送られたパラメーターで変更することにしました。  
新着順・投稿順はこれでかんたんにできます。  
いいね順をどうするかなと調べていた時に、Railsには`counter_cache`という機能があると知りました。  
参考：  
https://www.issoh.co.jp/tech/details/3727/  
https://qiita.com/Tohru-f/items/becb99329cb35c068877  
https://qiita.com/sazumy/items/e5399f113360e05032e0  
https://tech.spacely.co.jp/entry/2023/05/17/105350  
https://tech.spacely.co.jp/entry/2023/05/17/105350  
モデル間の関連データをキャッシュしてくれる機能で、テーブルにカラムを追加することになりますが、アソシエーションで関連付けられたオブジェクトの数を自動で計測して指定のカラムに保存してくれます。  
今回の場合は、
```ruby
class Review < ApplicationRecord
  has_many :likes, dependent: :destroy
end

class Like < ApplicationRecord
  belongs_to :review
end
```
で関連付けられてるので、まずLikeモデルに
```ruby
class Like < ApplicationRecord
  belongs_to :review, counter_cache: true
end
```
と設定して、Reviewモデルに`likes_count`というカラムを追加、マイグレーション時に`reset_counters`というメソッドを使って既存のオブジェクト数を保存させれば、あとはオブジェクトが増えたり減ったりするたびに自動で値を更新してくれます。  
後から`counter_cache`を使うときは、既存のオブジェクト数を自動で計測してくれないので、`reset_counters`という、`counter_cache`のカウント数をリセットするメソッドを使って既存のオブジェクト数を計測させています。  
これを使うと、毎回関連オブジェクトのカウントをクエリで取得する必要がなくなるそうです。  
ついでに、カラムで追加されるので、このカラムを指定して`desc`や`asc`を指定するだけでいいね数の多い順、少ない順で並べ替えれます。  
こっちの方が…楽だろ！！！  
というわけでいいね数ソートはこのやり方で実装します。  
`counter_cache`はポリモーフィック関連付けにも対応しているらしい？のでまた今度調べてみます。

