
:open_book:教材：[パーフェクトRuby on Rails【増補改訂版】](https://gihyo.jp/book/2020/978-4-297-11462-6)

7-4の続きから。

テスト用データを利用してテスト。  
test/system/events_test.rbを生成し、FactoryBotを使ってEventモデルのレコードを作成。  
作成したレコードのidを使って、/event/:idページへのurlを組み立て、`visit`メソッドでリクエストし、作成したイベントの名前が表示されることを確認。  

ログインヘルパーの作成。  
ログインが必要なページでもテストが行えるように、ログイン用のヘルパーを作成。  
test/sign_in_helper.rbを生成し、`sign_in_as`というヘルパーメソッドを定義。  
OmniAuthをモック化してテスト用の挙動に差し替える設定を記述し、テストでGitHub認証を実行すると引数で設定したレスポンスを返すように設定。  
メソッド内でGitHubへのログインリンクをクリックさせてログインするようにする。  
test/test_helper.rbに`require_relative 'sign_in_helper'`を追記してログインヘルパーをテストで使えるようにする。  

ログインが必要なページのテスト。  
作成したログインヘルパーを使用して、ログインを必要とするページのテストを作成。  
test/system/events_test.rbに/event/newページを表示するテストを記述。  
先ほど定義した`sign_in_as`メソッドとFactoryBotを使ってユーザーを生成しログイン処理を実行。
visitで/event/newページに移動。
テストを実行してみたら、エラーが発生。
[![Image from Gyazo](https://i.gyazo.com/fe4074684733d46fdbb2039e08523e4f.png)](https://gyazo.com/fe4074684733d46fdbb2039e08523e4f)
ポートが使われていて使用できないとのエラー。  
test/system/events_test.rbにはこの時テスト用データを利用してテストしたときのテストと、今回のログインが必要なページのテストの二つのテストが記述されている状態で、一つ目のテスト用データを利用してテストしたときのテストはテストが通っているが、二つ目のログインが必要なページのテストがポートが使えずにエラーになってしまっているようだった。  
ログの少し上の方を見ると、
[![Image from Gyazo](https://i.gyazo.com/98a685be575fcf2c267703c433a0f2c5.png)](https://gyazo.com/98a685be575fcf2c267703c433a0f2c5)
capybaraが2つ同時にpumaを起動していた。それぞれのテストで別々にシステムを起動して同時にテストを実行しようとしているのか？と思ったが、検索しようにもどう検索するかでちょっとなやんだ。  
そういえばRailsはテストの並列実行ができたなと思い出して、[ガイド](https://railsguides.jp/testing.html#%E4%B8%A6%E5%88%97%E3%83%86%E3%82%B9%E3%83%88)を見に行った。  
test_helper.rbに`parallelize(workers: :number_of_processors)`という記述があったが、この`parallelize`メソッドに渡されるワーカー数がプロセスがforkされる回数になり、デフォルトは実行されるマシンの実際のコア数になっているとのことだった。  
この数値が1以下だとテストは並列化しないとのことなので、デフォルトでテストが並列化する設定になっているのだなと思い、数値を1に変更。  
[![Image from Gyazo](https://i.gyazo.com/7cbb6298243de48392b19901401e7897.png)](https://gyazo.com/7cbb6298243de48392b19901401e7897)
無事にテストが通るようになった。  

データを入力して登録するテスト。  
/event/newへアクセスしてフォームへデータを入力して登録するテストを作成。  
fill_inとselectメソッドを使ってドームにデータを入力し、登録するボタンをクリックして作成しましたの文字が表示されることを確認。  

ダイアログを操作するテスト。  
データ削除のテストを作成。  
accept_confirm doメソッドは渡されたブロック内で表示されたダイアログに対してOKボタンを押すヘルパーメソッド。  

時刻を制御するテスト。  
travel_toヘルパーで現在時刻を変更してテストできる。  
トップページのイベント一覧で未来のイベントが表示されていて、過去のイベントが表示されていないことを確認するテストを作成。  
travel_toメソッドにブロックを渡すと、引数で渡した時刻（例えばTime.zone.now + 2.dayとか）が現在時刻として差し替えられる。  
