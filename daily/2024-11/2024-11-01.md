
:open_book:教材：[パーフェクトRuby on Rails【増補改訂版】](https://gihyo.jp/book/2020/978-4-297-11462-6)

4-3から。今日もカリキュラム比重おおめだったのでこっちは控えめ

### rails-ujs

RailsはJavaScriptを使ったHTMLの制御や画面遷移を制御する方法が標準で提供されている。  
ビューテンプレートで扱いやすいような仕組みになっている。  

Railsにはrails-ujsという画面の制御を補助するJavaScriptライブラリが組み込まれている。  
submitボタンを押したときにダイアログを表示したり、フォームの内容を二重送信しないように制御したりできる。  
直接JavaScriptを書かなくても、ビューテンプレートに少し記述を追加するだけで使える。  
例えば、`<%= form.submit data: { disable_with: '送信中' } %>`のように記述すると、submitボタンを押したときに送信中と表示される。  
ハッシュオブジェクトで指定したdisable_withの引数の値が、submitボタンを押したときに表示されるテキストになる。  
ここに`confirm: '実行してもよろしいですか？'`を追記すれば、submitボタンを押したときに実行してもよろしいですか？というダイアログが表示される。  

rails-ujsにはHTTPリクエストをAjax化する機能もある。  
ヘルパーメソッドのform_withがデフォルトでAjax通信を行う設定になっていて、`local: true`と書くことで通常の画面遷移になる。  
ただし、scaffoldで生成したformには`local: true`が指定されている。  
これを`local: false`に書き換えるとAjaxでの通信が行われる。  

### Turbolinks  

Railsには画面遷移を高速化するTurbolinksというライブラリが組み込まれている。  
TurbolinksはAjaxリクエストで取得したHTMLでーたのbodyタグ内を、現在表示しているページのbodyタグに反映させることで高速なページ遷移を実現している。  
この時にHistory APIのpushStateを使ってブラウザの戻るボタンへの対応やURLの変更なども行っている。  
pushStateとAjaxを組み合わせているので、Pjaxと表現されることもある。 
Turbolinksを使った画面遷移はbodyタグのみを切り替えて、headタグ内で必要なリクエスト数やレンダリングコストを削減しているので、普通に画面遷移するよりも高速に画面遷移が行える。  
しかし、bodyタグの中身を入れ替える都合上、JavaScript上のグローバルなオブジェクトにデータを保存するとデータがページ遷移とともに初期化されなくなるので、画面遷移で初期化されることを前提としたコードは書かない方がいい。  
また、JavaScriptを実行するときに使うonloadやDOMContentLoadedといったイベントが発火しないので、代わりに独自のタイミングで発火するイベントを用意している。  
イベントリスナーにturbolinks:loadというイベントを登録すると、最初に画面を表示した場合とTurbolinksで画面が切り替わった場合のタイミングでイベントをキャッチできる。  
他のイベントとしてクリック時に発火するturbolinks:clickやXHRリクエスト開始時に発火するturbolinks:request-startなどのイベントがある。  
Turbolinksは高速なページ遷移を実現できるライブラリだが、バリデーションエラーなどで画面遷移せずにレスポンスを返すような場合はコントローラーでJavaScriptで対応できるレスポンスを返すなどの工夫が必要となる。  
RailsではRailsアプリケーションとして扱いやすいように拡張したgemと合わせてTurbolinksを使っているので、あらかじめ機能や開発の方針として不要そうなことが若手いる場合は初期インストール時に省くことができる。  
