※スクール内timesの移植（2025/11/18）

画像を`purge`するだけで画像のカウント減ってる！から`decrement!`で余計にマイナスしてるんだ！  
ロボらんてくんZが最初に言ってた`purge`しただけじゃ親レコード更新はいらないよ～～～はRails6系の挙動の話だったみたい。  
最初にRailsのバージョンも教えてるんじゃけどお…  
というわけで解決  

copilotのコードレビューが日本語にならなくなっちゃったけどこれ作らなきゃならなくなったん？  
https://qiita.com/TooMe/items/873540da84567733d16b  
助かるんだぜ…って思ったら先輩の記事だった。ありがとうございます！  
https://zenn.dev/aya1357/articles/b75938384172df  

昨日の続きやってました。  
昨日、ロボらんてくんZと画像の枚数表示について相談しながら実装していた時、**`purge`してもActiveStorageの添付ファイルが消えるだけで親のReviewレコードは更新されないから`after_commit`コールバックは発火しないよ**と言われたのですが、今日ログやデバッグで確認したところ、**`purge`時に親のReviewレコードも更新されてました**。  
ちょっと！ロボらんてくんZ！！ぼく昨日`purge`したら親レコードの`update_at`更新されてるけどほんとに発火してないの？って聞いたじゃん！！（ログを確認しろ）  
なので、`purge`時にも`after_commit`コールバックが発火して`image_count`カラムの値が最新の画像枚数に更新されてました。  
昨日、`purge`後に`decrement!`したら`画像枚数が表示されなくなった`のは、もともと適当に3枚くらい画像添付してたレコードで確認していたので、`画像を一枚削除→after_commitが発火してimages_countカラムの値が2になる→decrement!実行によりimages_countの値が1になる→画像が0～1枚の時は画像枚数を表示しないので画像枚数が表示されなくなる`ということでした。4枚添付で1枚削除だったら気づけたなこれ…。  
ロボらんてくんZにこの辺確認したら、`Rails6系はpurge後に親レコードが更新されないことがあった。Rails7系は親レコードが更新されます！`とのことでした。ちょっと？？？Rails7.2使ってるって伝えたよね？？？  
というわけで、  
```ruby
  def update_images_count
    current_count = images.attached? ? images.count : 0
    update_column(:images_count, current_count) unless images_count == current_count
  end
```
みたいなカスタムメソッドを`after_commit`でレコードが`COMMIT`された際に実行されるようにしました。  
画像のみ削除の時に追加でいろいろやる必要もなくなったのでシンプルになったかなと思います。ロボらんてくんZへのプロンプトもうちょっと工夫しないとかな…。  
ようやくN+1対応が終わったかなと思います。今後また何かしら出てくると思うけど…たぶん抜けもれあると思うから…。  
でも、アラートで対応しやすくなったので良かったなと思います。  

というわけでプルリク作ってmergeしよ…とプルリクを作ったら、いつも日本語でレビューしてくれるCopilotちゃんが宇宙語をしゃべるようになっちゃいました。この宇宙語ね、英語っていうんだって。  
先週くらいまではプルリクに「`日本語でレビューして`」ってお願いしておけば日本語でレビューしてくれたのですが、日本語を使ってくれなくなりました。  
DeepL翻訳の拡張機能を入れているので英語のままでも読めなくはない…のですが、やっぱりストレスなので日本語対応させるべく調べていたら、どうも`.github/copilot-instructions.md`というファイルを作って指示しないといけなくなった？らしい？です。  
GitHub公式ドキュメントもある…のですが、日本語化が中途半端で何書いてるのか全然わからんので他の記事などを探して参考にしながら作ってみました。  
https://zenn.dev/aya1357/articles/b75938384172df  
参考文献が偉大なる先輩の記事でした。ありがとうございます！！！！！  
次のプルリクを出すまでCopilotちゃんが日本語を思い出してくれるかはわかりませんが、なんとか日本語を思い出してほしいと思います。  

明日はいろいろ出かけたりなどなのであんまりできないかも。  
食洗器が壊れかけなので新しいのを見繕いに行きます。  
できそ～～～だったら書いてる途中の記事の続き書くための調査等をやる。  

