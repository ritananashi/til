※スクール内timesの移植（2025/09/30）

https://github.com/rails/solid_queue/issues/365  
GPTにも聞いてみたけどissueにあった
```ruby
ActiveRecord::Base.establish_connection(:queue)
load 'db/queue_schema.rb'
```
でよさそう
`\l`効かないから`\dt`で見てみてるけどSolid QueueのDBできたっぽい！  
[![Image from Gyazo](https://i.gyazo.com/b84c27fad378fa525ebfdc570100c36a.png)](https://gyazo.com/b84c27fad378fa525ebfdc570100c36a)  
なんかちがうかも？  
ActiveJobが動いてないからなんか違うわ  
primaryのDBにSolid Queueのテーブル追加しちゃった  
同一DBでも設定変えれば運用できるけどどうしような  
ばっくあっぷとって…てーぶるさくじょして…`bin/rails db:create:queue`…？でいいのか？  
`bin/rails db:create:queue`でDB作れんが  
DB作れた :v:  
うまくいったー！！！  
[![Image from Gyazo](https://i.gyazo.com/28887b93df4caf0d5ebd7e9ebd0a9741.png)](https://gyazo.com/28887b93df4caf0d5ebd7e9ebd0a9741)  
じゃ、primaryDBのよけいなSolid Queueのテーブル消すね…。バックアップなんかうまくできなくてバックアップなしでやることになっちゃったけど…。  
リネームしてちょっと様子見てから消すことにした（GPTの提案）  
というわけでできました  
[![Image from Gyazo](https://i.gyazo.com/c6c2af1e8ecabe5bad4c7931b15072f3.png)](https://gyazo.com/c6c2af1e8ecabe5bad4c7931b15072f3)  

昨日からやってたSolid QueueのDBが作成されてないっぽいんじゃが問題解決！  
ローカルでは`db:prepare`で問題なく新樹DB作成されてたから実装終わったら軽くデプロイしてActiveJobの動作確認するだけ～～～とか思ってたら沼った。  
Railsはdatabase.ymlで`host: db`となっていても環境変数で`ENV["DATABASE_URL"]`が設定されていれば環境変数を優先して適用する…らしいのですが、どうも`ENV["DATABASE_URL"]`ではなく`host: db`を参照していてエラーになっていました。  
この時のdatabase.ymlはSolid Queue公式READMEに載ってる内容の通りにやってました。  
```yaml
production:
  primary: &primary_production
    <<: *default
    database: app_production
    username: app
    password: <%= ENV["APP_DATABASE_PASSWORD"] %>
  queue:
    <<: *primary_production
    database: app_production_queue
    migrations_paths: db/queue_migrate
```
これだと`host: db`がなぜか優先されてしまっていたみたいです。  
なので、`url`で`ENV["DATABASE_URL"]`を参照するように明示的に書いてみました。  
ひとまずこれでDBにアクセスできるようにはなりました。  

その後、どうもSolid QueueのDBが作られてないっぽいぞ？ということで、色々調べたりGPTに聞いたりしてました。  
https://github.com/rails/solid_queue/issues/365  
公式issueに類似の状況のものがあり、
```ruby
ActiveRecord::Base.establish_connection(:queue)
load 'db/queue_schema.rb'
```
で解決しているようだったので、これを実行…してみたのですが、Solid QueueのDBが作られていなかったがために、primaryのDBにSolid Queueのテーブルが作成されてしまいました。  
ActiveJobはインク登録時に裏で楽天で検索して取得した情報を反映する、以外に使う予定（いまのところ）ない上、インクが新規に登録される機会はそんなにないだろう…と思うので、設定を諸々変えて同一DBでの運用に切り替えても良かったのですが、ローカルではDB別でやってるので、同一DB使用の設定に変えるとなるとローカルも変えないとなのでめんどいし（とはいえローカルのDBはいじくりまわしても影響ないから別にいいだろとも思う）、primaryに混ざってるのはキモチワルイので頑張って分けることにしました。  

DBの新規作成は`db:create:queue`でできる…はず…ですが、なぜかprimaryのDBが「もうできてるよ！」と表示されました。なんでや。  
`ENV["DATABASE_URL"]`のなかみは、`postgres://<username>:<password>@<db-app-name>.flycast:5432/<db-name>?sslmode=disable`みたいになってます。（flyのコンソールに入ってから`echo $DATABASE_URL`でみれる）。  
この`<db-name>`はprimaryのDB名になってたのですが、どうもこのせいで`primaryのDBを作成する`ようになってたようです。  
`<db-name>`を作りたいSolid Queue用のDB名に変えて、新しい環境変数`QUEUE_DATABASE_URL`に登録して再デプロイ（dlyの環境変数の適用にはデプロイが必要）したところ、自動で新しいDBが作成されました。なるほどー。  
この状態で
```ruby
ActiveRecord::Base.establish_connection(:queue)
load 'db/queue_schema.rb'
```
を実行したところ、無事にSolid QueueのテーブルがSolid QueueのDBに作成されました。やったぜ。

テストとして新しくインクを登録したところ、ジョブは登録されるけど実行されない…というようになりました。  
GPTに聞いたら`bin/rails solid_queue:start`を実行するように言われたので実行したところ、ジョブが実行されました。  
つまり`bin/jobs`が実行されてないな？  
ということでGPTに相談。  
公式ドキュメント[https://fly.io/docs/launch/processes/](https://fly.io/docs/launch/processes/)を参考にfly.tmolに`[processes]`に`bin/jobs`を実行するプロセスを追加しました。  
再びテストでインクを登録したところ、無事にジョブが実行されました。  
というわけで楽天APIの導入、ようく完了！です！  

余談ですが、fly.tmolにプロセスを追加するときに、`html_services`の下に追加したらデプロイに失敗しました。  
`html_services`の上にプロセスを追加するとうまくいったので、プロセス→`html_services`の順番じゃないとだめそうです。  

今日やったからあしたはおやすみ！

