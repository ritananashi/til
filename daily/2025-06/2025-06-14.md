※スクール内timesの移植（2025/09/19）

activestorageつかったモデルテストでhas_one_attachedだと`fixture_file_upload`が使えるけどhas_many_attachedだと使えないな～なんでだろな  
@review.images = [fixture_file_upload('spec/fixtures/files/image/dummy_1kb.svg')]みたいな配列の形式にしたらいけたから配列にしないとだめみたいだな？  
配列の形で渡せばいいとわかれば複数枚画像投稿で指定枚数以上投稿しようとしたときのバリデージョンもテストできるな  

- 学習時間：4h/22h/1006h
- 学習内容：卒制

reviewモデルのモデルスペック書いてました。  
reviewはproductモデルと一対多で関連してて、productはbrandモデルと一対多で関連しているので、データを作るのにこの二つも必要だな？と思って一緒にproductとbrandのファイルも生成しました。  
productのテスト用のデータを作るときに、ActiveHashを使っているCategoryのデータをどうするかでちょっと悩んで調べたりしました。  
ActiveHashのデータをfactory_botで使うときは、`category { Category.all.sample }`のようにすればよいみたいです（参考：https://qiita.com/kaket4n/items/4c341fb9907848a7acd4）。  
`Category.all`でActiveHashで作った擬似モデルCategoryのデータ全部取得、`sample`で取得したデータのうち一つをランダムに返す、ですね。  
`before(:create)`を使って、productのcreate前に`Category.find(1)`で最初のデータを探してそれだけ使おうと考えてたんですけど、これではnilになってダメでした。

reviewは複数枚画像が投稿できるので、画像についてのテストも書いていました。  
当初、userモデルの時のように`@review = fixture_file_upload('spec/fixtures/files/image/dummy_1kb.svg')`と書いたのですが、`ActiveSupport::MessageVerifier::InvalidSignature:   mismatched digest`というエラーが出てしまいました。  
`@review.images.attach`でやったら問題なくテストが通ったので、これでやるかと思いましたが、`attach`だと複数枚画像を添付するときは`@review.images.attach(params[images])`みたいな形になるよなと思ってどうしたものかとしていました。  
画像を配列で渡せば良いようです→https://qiita.com/kawadesu88/items/808d3f61b8b3f28d94e3  
ストロングパラメータでも配列で受け取れるように`images: []`と書きますし、配列で渡せば良いだけだったんだなあと自分の勘所の悪さにちょっとおちこみ。  
この配列の形にすれば、`fixture_file_upload`をつかえます。ActiveStorageの`has_many_attached`を使ってるときのテストデータは配列にしなければならない様です。  
複数枚渡すときは
```ruby
...
        @review.images = [
          fixture_file_upload('spec/fixtures/files/image/dummy_1kb.png'),
          fixture_file_upload('spec/fixtures/files/image/dummy_1kb.png'),
          fixture_file_upload('spec/fixtures/files/image/dummy_1kb.png'),
          fixture_file_upload('spec/fixtures/files/image/dummy_1kb.png')
        ]
...
```
`fixture_file_upload`で必要数分の要素を作ればいいだけです


ひとまず本リリ前に書くモデルテストは終わったので、次はシステムテスト書きます。明日は定期お休み日なので明後日から。

