※スクール内timesの移植（2025/09/19）

モデルテスト書いてるとたまにgreenだったテストがredになって、テストやり直すとgreenになる謎現象発生してる

ddコマンドで中身のないダミーデータが作れる  
https://linux.joho.info/command/dd-cmd/  
https://qiita.com/r_o/items/ef72ad1a7c21ba8c1d15  
https://qiita.com/miisha/items/3a6784f74fee3a60d5ad  

あーわかった。fakerで作ってるダミーデータに記号が入るときがあるんだ。accountのバリデーションは英数字のみにしてるからそれで引っ掛かるんだ。  
む、active_storage_validationsの`spoofing_protection`（コンテンツタイプ偽造保護）をtrueにしてるせいでさっき作ったダミーデータだとエラーになっちゃう  
とりあえず拡張子変えただけのファイルのアップロードを防げているのはいいことですね…ダミーデータどうしよ  
ん～～～ダミーじゃない本物の画像を用意するかなんか別の手段探すか  
本物画像を探してたら懐かしすぎる素材サイト出てきて「まだ生きてたん…？」となっていた  
Gに作らせた  
バリデーションのテスト終わったけどモデルテストってあと何書くんだ  
バリデーションだけでよさそう  

- 学習時間：4h/18h/1002h
- 学習内容：卒制

学習時間の記録が1000時間をこえました。9か月ぴったりではないけどがんばったなあと思います。

userモデルのモデルスペックを書いてました。  
Fakerを使ってFactory_botでテスト用のデータを作って、models/user.rbとにらめっこしながらバリデーションのテストを書きました。  
たまにテストがgreenだったのがredになることがありました。どうも`build`しようとしてるユーザーデータがうまく作れてなかったようです。  
何でだろうと思ってコンソールでFakerのコマンドを叩いてみたら、`account`カラムのデータを生成するのに使ってる`Faker::Internet.username(specifier: 5..8)`の生成データに記号が入ることがありました。  
[![Image from Gyazo](https://i.gyazo.com/cd97bb815af6649fff93813a7f3b032e.png)](https://gyazo.com/cd97bb815af6649fff93813a7f3b032e)
`account`カラムには半角英数のみ許可しているので、このために`account`カラムでのバリデーションエラーをチェックしてるテスト以外でも`account`カラムのバリデーションに引っ掛かってしまってうまくユーザーデータが生成できていなかったようです。  
`account`カラムに入れるデータは適当な文字列と連番にしてデータを作ることにしました。  

画像のバリデーションもチェックしたかったので、当初`ddコマンド`で指定したファイルサイズと拡張子のダミーファイルを作成しました。  
`ddコマンド`については→https://linux.joho.info/command/dd-cmd/  
バリデーションの失敗パターンのテストでは問題ないように見えたので、成功パターンのテストを書いたのですが、content_typeのバリデーションに失敗してしまいました。
`ddコマンド`で作ったファイルは、拡張子を作りたいファイルのものにしていても中身は違うので、`active_storage_validations`のコンテンツ形式偽造保護のオプション（`spoofing_protection`）を`true`にしていると通らないようです。  
`active_storage_validations`はfileコマンドとgem`Marcel`を使ってMIMEタイプというものを確認しています。  
MIMEタイプはファイルの種類の情報で、拡張子を変えただけではこっちは変更されません（あたりまえ）。  
`ddコマンド`で作ったファイルのMIMEタイプを調べてみましたが、`application/octet-stream`だったので（これは中身が不明なファイルにつくMIMEタイプらしいです）そもそも`ddコマンド`では`spoofing_protection`オプションに引っ掛からないファイルは作れないようです…。  
適当なファイルサイズのフリー画像とかないかなと思いましたが、微妙に不審なサイトしか見つけられなかったのでGPTにお願いして作ってもらいました。
作ってもらったファイルで画像のバリデーションのテストがどうなるか確認しましたが、無事にgreenになりました。  
ファイルサイズを少しずつ変えたものや拡張子が違うものも作ってもらったので、使用する画像ファイルをredになるだろうものに変えたりして試してみましたが、想定通りredになったので問題ないと思います。  


あとモデルスペックでなのかやることあるかなと思いましたが、ひとまずバリデーションのテストだけでよさそうだったので、明日はreviewモデルのモデルスペックを書こうかなと思います。

