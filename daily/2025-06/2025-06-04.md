※スクール内timesの移植（2025/09/19）


今日も今日とて胃が痛いので、やれそうなタイミングでちょっとだけ頑張るくらいでやります。  
とりあえず使い方ガイドを作って検索不具合調査がしたいヨォ〜〜〜  

あ、検索不具合の原因Turbo_frameの遅延読み込みかもしれん  
Turbo_frameの`src`に設定してた検索のパスに検索ワード渡してなかったから検索ワードなしの時の表示になっちゃってたっぽい。
なおった。  

- 学習時間：3h/6h/972h
- 学習内容：卒制

昨日胃カメラを受けました。結果は異常なしです。  
異常なかったのはよかったのですが、5月から続いている不調が原因不明のままなので、どうしたものか…としています。  
かかりつけ医からは、特に原因になりそうなものがないので神経性かなと言われましたが、心当たりになるストレスがないので…（転職とか本リリースとかいろいろあるけどそこまでストレスは感じてないです）。  
来週大きい病院の方の定期通院日なので、そっちでも相談はしてみようと思いますが、消化器系の診療科じゃないので進展はしないと思います。  
消化器系の診療科受診となると、通院してる診療科からの紹介じゃなくてかかりつけ医からの紹介という形になると思うし…昨日それ系の話はなかったので…。  
とりあえず、回復のめどが全く立たない上本リリース予定日が迫ってきているので、延長申請しますね…。  
就活も進められていないので、気持ちばかりが焦っているような気がします。  

使い方ページをざっくり作成して、こないだ見つけた検索機能の不具合直しました。  
検索結果画面で、レビューのほうだけTurbo_frameの遅延読み込みを使って、読み込みが終わるまでスケルトンスクリーンを表示するようにしていたのですが、`src`にパスだけ設定して検索ワードを渡していなかったのが原因でした。  
```ruby
...
# Turbo_frameで遅延読み込み中にローディングのスケルトンスクリーンを表示するやつ
    <%= turbo_frame_tag "search_reviews", src: search_reviews_path do %>
      <%= render "shared/skeleton_card" %>
    <% end %>
...
```
Turbo_frameの遅延読み込みは、`src`に設定したページの読み込みが終わるまで、ブロック内の要素を表示します。  
読み込みが終わったら、`src`に設定したページをTurbo_frame内にレンダリングするので、たとえ検索ボタンをクリックして遷移してきても、`src: search_reviews_path`に検索ワードが渡されていなかったら、検索ワードなしで検索したときと同じ結果が表示されてしまいます。`src: search_reviews_path`に検索ワード渡されてないので…。  
なので、
```ruby
...
    <%= turbo_frame_tag "search_reviews", src: search_reviews_path(q: params[:q], c: params[:c]) do %>
      <%= render "shared/skeleton_card" %>
    <% end %>
...
```
みたいに検索ワードを渡してあげたら、きちんと検索結果が表示されるようになりました。  
自分は（一つの検索フォームで二つのモデルを別々に検索する都合上）Ransackの`search_form_for`は使わないで`form_with`でやっているので、`search_form_for`を使ってるときはまたちょっと書き方変わると思います。  
Turbo_frameの遅延読み込みでローディング作るの簡単～～～とか思ってましたが、思わぬ伏兵でした。精進します。  
とか思ったけどプロフィール画面の遅延読み込みではちゃんと必要な値渡してるのでただのポカミスです。ぴえん。  

