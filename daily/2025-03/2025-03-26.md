※スクール内timesの移植（2025/09/04）

バリデーションエラーメッセージのカスタマイズができた回
[![Image from Gyazo](https://i.gyazo.com/2bbd456cd2b39091322d93ff6eec3756.png)](https://gyazo.com/2bbd456cd2b39091322d93ff6eec3756)

- 学習時間：4h30min/14h30min/707h30min
- 学習内容：卒制

一昨日ただの散歩になっちゃったお使いのリベンジに行ってきました。今度はちゃんと頼まれた商品あったよ。  
あと美容室も行ったりしていたので今日はあんまり時間が取れませんでした。ちょっと進んだからヨシ！  
  
昨日の続きをやっていた…と言いたいところだけど、今日やってたバリデーションエラーメッセージのカスタマイズは完全に今やらなくていい寄り道なのでこういうのも本リリースに回すようにした方がいいんだろうなと思いました。  
2時間くらいやってたから…。  
バリデーションエラーメッセージのカスタマイズですが、reviewモデルと`belongs_to`でつながってる`product_id`のバリデーションエラーメッセージを、入力フォームの「インクを選択」ボタンに誘導するようなものに変えたくてやってました。  
もともとは「インクを入力してください」だったんですけど、これだと「インクの選択画面から選ばずに、直接（DBに保存されてない）インクを入力してるのにエラーがでる」みたいなことが発生したときに、ユーザーがどう対応をすればいいかわかりにくいので…。  
最初は`:message`オプションを使ってやればいいじゃないのと思ってやってみたのですが、「インクを入力してください」のエラーメッセージとは別にエラーメッセージが出てしまったので、別のやり方を探してみました。  
[ActiveRecordのvalidatesで表示されるエラーメッセージのフォーマットを変更する](https://qiita.com/okeicalm/items/9638250ddfb361d80a16)  
[Active Recordモデルで翻訳を行なう](https://railsguides.jp/i18n.html#active-record%E3%83%A2%E3%83%87%E3%83%AB%E3%81%A7%E7%BF%BB%E8%A8%B3%E3%82%92%E8%A1%8C%E3%81%AA%E3%81%86)  
[どのフィールドにどの検証エラーが追加されたのかを、「表示言語やエラーメッセージに依存しない形で」テストする方法](https://qiita.com/jnchito/items/6cf94a82e719c1dca5f1)  
[Rails: 個別のバリデーションエラーをErrorオブジェクトにカプセル化する（翻訳）](https://techracho.bpsinc.jp/hachi8833/2020_10_19/95130)  
[Railsの日本語化とエラーメッセージのカスタマイズ](https://zenn.dev/machamp/articles/rails-validation-message)  
参考資料です。  
最初は`config/locals/activerecord/ja.yml`に
```yml
...
    errors:
      models:
        review:
          attributes:
            product_id:
              blank: "は「インクを選択」から選んでください。"
```
でやったのですが、全く反映されませんでした。ぴえん。  
エラーメッセージは
```
activerecord.errors.models.[model_name].attributes.[attribute_name].[key]
activerecord.errors.models.[model_name].[key]
activerecord.errors.messages.[key]
errors.attributes.[attribute_name].[key]
errors.messages.[key]
```
この順番で上から探して最初にマッチするものを返すそうです。  
`[key]`が違うのかな？と思ってコンソールで調べてみました。
```ruby
myapp(dev)> review = Review.new
=> #<Review:0x00007f493b213f28
...
myapp(dev)> review.valid?
=> false
myapp(dev)> review.errors.full_messages
=> ["Userを入力してください", "インクを入力してください", "タイトルを入力してください", "本文を入力してください"]
myapp(dev)> review.errors.where(:product_id)
=> []
myapp(dev)> review.errors.where(:product)
=> [#<ActiveModel::Error attribute=product, type=blank, options={:message=>:required, :if=>#<Proc:0x00007f493ba7e168 /usr/local/bundle/gems/activerecord-7.2.2.1/lib/active_record/associations/builder/belongs_to.rb:130 (lambda)>}>]
```
そもそもproduct_idじゃないやんというツッコミはさておいて、`review.errors.where(:product)`の返り値を見ます。  
`type`が`blank`です。  
参考に`title`と`body`の値がどうなってるか見てみます
```ruby
myapp(dev)> review.errors.where(:title)
=> [#<ActiveModel::Error attribute=title, type=blank, options={}>]
myapp(dev)> review.errors.where(:body)
=> [#<ActiveModel::Error attribute=body, type=blank, options={}>]
```
`type`が`activerecord.errors.models.[model_name].attributes.[attribute_name].[key]`の`[key]`にあたるっぽいですね。  
だけどさっきのja.ymlではproductのメッセージは変わりませんでした。  
ところでデフォルトのエラーメッセージのフォーマットは`%{attribute}%{message}`になってるっぽいです。  
ここで`review.errors.where(:product)`の返り値をもう一回見てみると、`options={:message=>:required,`という記述があります。  
これ、`%{message}`に`:required`に対応するメッセージを表示するよう指定してるんじゃないの？で、これが`[key]`なのでは？と思って、ja.ymlを編集しました。
```yml
...
    errors:
      models:
        review:
          attributes:
            product:
              required: "は「インクを選択」から選んでください。"
```
[![Image from Gyazo](https://i.gyazo.com/2bbd456cd2b39091322d93ff6eec3756.png)](https://gyazo.com/2bbd456cd2b39091322d93ff6eec3756)  
上手くいきました :v:   
上手くいったけど、本筋放置してここに時間をかけてしまったので良くなかったなと思います。反省。
