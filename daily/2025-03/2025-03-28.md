※スクール内timesの移植（2025/09/04）

[lib/active_storage_validations/analyzer/content_type_analyzer.rb](https://github.com/igorkasyanchuk/active_storage_validations/blob/master/lib/active_storage_validations/analyzer/content_type_analyzer.rb)  
によると、
```
  # = ActiveStorageValidations ContentType \Analyzer
  #
  # Extracts the content type from an attachable. This is used to prevent content
  # type spoofing.
  #
  # Example:
  #
  #   ActiveStorageValidations::Analyzer::ContentTypeAnalyzer.new(attachable).content_type
  #   # => { content_type: "image/png" }
  #
  # This analyzer requires the {UNIX file}[https://en.wikipedia.org/wiki/File_(command)] command, which is not provided by \Rails. While it is available on most UNIX distributions, it may need to be installed explicitly on minimal or custom setups.
```
翻訳すると
```
ActiveStorageValidations ContentType \Analyzer

 アタッチャブルからコンテンツ・タイプを抽出します。これはコンテンツタイプ
 タイプの偽装を防ぐために使用されます。

 例

   例: ActiveStorageValidations::Analyzer::ContentTypeAnalyzer.new(attachable).content_type
{ content_type： 「image/png" }.

 このAnalyzerには{UNIX file}[https://en.wikipedia.org/wiki/File_(command)]コマンドが必要です。ほとんどのUNIXディストリビューションで利用可能ですが、最小セットアップやカスタムセットアップでは明示的にインストールする必要があるかもしれません。
```
つまり`gem active_storage_validations`で`content_type`のバリデーションをしたいなら、UNIXの`file`コマンドが必要になるのでこれをインストールしていないといけない。  
[![Image from Gyazo](https://i.gyazo.com/c71f42cab73b64d027436385bade9645.png)](https://gyazo.com/c71f42cab73b64d027436385bade9645)  
通常のRuby3.6.6には`debian/file`がパッケージに入っている。  
[![Image from Gyazo](https://i.gyazo.com/eb60ba04d16ecab35ec4fb5f0bc6d9c7.png)](https://gyazo.com/eb60ba04d16ecab35ec4fb5f0bc6d9c7)  
Railsが自動で作ってくれる本番環境用DockerfileでインストールされてるRubyはこっち。こっちには`debian/file`がパッケージに入っていないので`content_type`のバリデーションを使うと`file`コマンドがないのでエラーが出る、ということか…。

- 学習時間：6h/27h30min/720h30min
- 学習内容：卒制

本番環境での画像投稿ができました…。  
`ActiveStorageValidations::Analyzer::ContentTypeAnalyzer::FileCommandLineToolNotInstalledError`を検索かけてもあまりにも何も出てこなさ過ぎてGPTに聞いてみたけど、ソース元不明の情報が返ってきたのでぺっ使えねえな…と思いながら調査続行したりなどしてました。  
エラー文に`ActiveStorageValidations`が入ってるあたり`gem active_storage_validations`になんか情報ないかなとソースコートを探してみたら、[lib/active\_storage\_validations/analyzer/content\_type\_analyzer.rb](https://github.com/igorkasyanchuk/active_storage_validations/blob/master/lib/active_storage_validations/analyzer/content_type_analyzer.rb)に
```
  # = ActiveStorageValidations ContentType \Analyzer
  #
  # Extracts the content type from an attachable. This is used to prevent content
  # type spoofing.
  #
  # Example:
  #
  #   ActiveStorageValidations::Analyzer::ContentTypeAnalyzer.new(attachable).content_type
  #   # => { content_type: "image/png" }
  #
  # This analyzer requires the {UNIX file}[https://en.wikipedia.org/wiki/File_(command)] command, which is not provided by \Rails. While it is available on most UNIX distributions, it may need to be installed explicitly on minimal or custom setups.
```
との記述がありました。大事なのが最後の行で、翻訳すると`このAnalyzerには{UNIX file}[https://en.wikipedia.org/wiki/File_(command)]コマンドが必要です。ほとんどのUNIXディストリビューションで利用可能ですが、最小セットアップやカスタムセットアップでは明示的にインストールする必要があるかもしれません。`ということになります。  
ソースコードには`class FileCommandLineToolNotInstalledError < StandardError; end`との記述がありますが、これは例外クラスを独自に定義している記述ですね（チェリー本9章p399-400）。  
つまり調べても調べても出てこなかった`FileCommandLineToolNotInstalledError`は`gem active_storage_validations`が独自に定義した例外ってことですね。調べても出てこないわけだ。  
`read_media`メソッドで`Errno::ENOENT`を補足したら独自に定義した`FileCommandLineToolNotInstalledError`と`"file command-line tool is not installed"`のメッセージを返すようになってるのかな？（ここ自信ない）  
`Errno::ENOENT`は`システムコールのエラーコードを表す例外クラス`だそうです => [class Errno::ENOENT](https://docs.ruby-lang.org/ja/latest/class/Errno=3a=3aENOENT.html)　[class Errno::EXXX](https://docs.ruby-lang.org/ja/latest/class/Errno=3a=3aEXXX.html)  
いろいろごちゃごちゃ書いたけど、UNIXのfileコマンドがないときにエラー発生させてるってことだと思います。  
ものは試しでContentTypeへのバリデーションを一時的にコメントアウトして本番環境で試しに画像を投稿してみたところ、無事に投稿できました。投稿した画像もS3に入ってきたので問題なさそうです。  
というわけで、ContentTypeのバリデーションを行うときにfileコマンドがないために投稿に失敗してるんだろうなと思いました。  
でも、開発環境でfileコマンドのインストールなんてしてないぞ？本番環境と開発環境で何が違うんだ？と思ったのでGPTくんにまた聞いてみたら、Dockerfileのベースイメージが違うかもとの返答が返ってきました。  
とはいえGPTくんのいうことなので真に受けすぎてはいけないので、開発環境で使ってるRubyのイメージと本番環境で使ってるRubyのイメージを公式で調べてみました。  
開発環境で使ってるRubyが[こっち](https://hub.docker.com/layers/library/ruby/3.3.6/images/sha256-86b68ff1a077f1213f8fc2a0ae47423aff0ec63a6d1bae469e94b0a60d5e7512)  
本番環境で使ってるRubyがたぶん[こっち](https://hub.docker.com/layers/library/ruby/3.3.6-slim/images/sha256-460dd65870f8d1799f4ae246af6732aec1d3183365cd8c89e70508863224ea7b)  
開発環境の方には`debian/file`がパッケージに入っています。[debian/file](https://packages.debian.org/ja/sid/file)は`file`コマンドを提供してくれているようです。  
[![Image from Gyazo](https://i.gyazo.com/c71f42cab73b64d027436385bade9645.png)](https://gyazo.com/c71f42cab73b64d027436385bade9645)  
本番環境には`debian/file`はありません。  
[![Image from Gyazo](https://i.gyazo.com/eb60ba04d16ecab35ec4fb5f0bc6d9c7.png)](https://gyazo.com/eb60ba04d16ecab35ec4fb5f0bc6d9c7)  
本番環境の方には`debian/file`がないので`file`コマンドが使えないようです。  
本番環境のDockerfileのベースイメージから`-slim`の記述を削除し、デプロイして本番環境で投稿を試したら無事に画像の投稿ができました。  
  
今はSwiperでサムネイル付きスライダー作ろうと頑張ってます。CSSがあ…読み込まれなくてえ…。アセットパイプライン調べるね…。
