※スクール内timesの移植（2025/09/04）

AWS S3 導入したらエラーでてデプロイできないンゴ…。  
なんか認証情報読み込まれてないっぽい。  
`Error retrieving instance profile credentials: Failed to open TCP connection to 169.254.169.254:80 (execution expired)`  
このエラーが関係してそうな気がする。

https://community.fly.io/t/error-build-6-6-run-secret-key-base-dummy-1-bin-rails-assets-precompile/22562
 :thinking_face: Deviseちゃん…？

 - 学習時間：7h/21h30min/714h30min
- 学習内容：卒制

画像投稿機能作ってました。  
もともとActiveStorage先に入れてしまっていたので、ローカルでは特に苦労せず画像投稿できました。  
S3を導入して、fly.ioにデプロイしてみたときに、エラーが出てデプロイが失敗しました。  
[https://community.fly.io/t/error-build-6-6-run-secret-key-base-dummy-1-bin-rails-assets-precompile/22562](https://community.fly.io/t/error-build-6-6-run-secret-key-base-dummy-1-bin-rails-assets-precompile/22562)  
この公式コミュニティの質問が近い状況で、どうもDeviseが悪さしているようだったので、  
https://github.com/heartcombo/devise/issues/5231  
Devise公式のissueを参考に修正したらデプロイできました。  
そのあと本番環境で投稿機能を試しましたが、今のところエラー出て画像アップロードができません。
```
nrt [info] I, [2025-03-27T08:53:12.872956 #627] INFO -- : [78c1f4b8-1e8b-47ed-911f-d421b77846a1] Parameters: {"authenticity_token"=>"[FILTERED]", "review"=>{"title"=>"画像投稿テスト", "images"=>["", #<ActionDispatch::Http::UploadedFile:0x00007f0265c7d300 @tempfile=#<Tempfile:/tmp/RackMultipart20250327-627-mjlduy.JPEG>, @content_type="image/jpeg", @original_filename="IMG_3169.JPEG", @headers="Content-Disposition: form-data; name=\"review[images][]\"; filename=\"IMG_3169.JPEG\"\r\nContent-Type: image/jpeg\r\n">], "body"=>"画像投稿テスト", "product_name"=>"ミッドナイトブルー", "paper"=>"LIFEマージンレポート 5mm方眼", "pen"=>"Pelikan スーベレーン M800 クリームブルー"}, "commit"=>"登録する"}
nrt [info] I, [2025-03-27T08:53:12.950260 #627] INFO -- : [78c1f4b8-1e8b-47ed-911f-d421b77846a1] Completed 500 Internal Server Error in 77ms (ActiveRecord: 21.3ms (3 queries, 0 cached) | GC: 0.0ms)
nrt [info] E, [2025-03-27T08:53:12.952440 #627] ERROR -- : [78c1f4b8-1e8b-47ed-911f-d421b77846a1]
nrt [info] [78c1f4b8-1e8b-47ed-911f-d421b77846a1] ActiveStorageValidations::Analyzer::ContentTypeAnalyzer::FileCommandLineToolNotInstalledError (file command-line tool is not installed):
nrt [info] [78c1f4b8-1e8b-47ed-911f-d421b77846a1]
nrt [info] Causes:
nrt [info] [78c1f4b8-1e8b-47ed-911f-d421b77846a1] Errno::ENOENT (No such file or directory - file)
nrt [info] [78c1f4b8-1e8b-47ed-911f-d421b77846a1]
nrt [info] [78c1f4b8-1e8b-47ed-911f-d421b77846a1] app/controllers/reviews_controller.rb:22:in `create'
```
出てるエラーログがこれ。  
`ActiveStorageValidations::Analyzer::ContentTypeAnalyzer::FileCommandLineToolNotInstalledError (file command-line tool is not installed)`このメッセージで調べたけど検索結果が出ませんでした。  
`file command-line tool is not installed`？なので何か必要なものがインストールできてないっぽい？のですが、何が足りてないのかがよくわかりません。  
本番環境用のDockerfileにlibvipsとimagemasickをインストールする記述はあるけど…。  
もう一個のエラー`Errno::ENOENT (No such file or directory - file)`も検索かけてみましたが割と途方もなかったというか類似の状況がなかったです。  
ディレクトリとファイルがないよってことみたいなので、`@tempfile=#<Tempfile:/tmp/RackMultipart20250327-627-mjlduy.JPEG>`ここが怪しいんじゃないのと思いますが、`@tempfile`とかで調べてもうまく出てこなかったです。  
そもそも`/tmp/`に入ってるのが正しいのか？S3へのアップロードってどこになるんだろ。投稿に失敗してるから`/tmp/`なのかな？  
よくわからない…。
