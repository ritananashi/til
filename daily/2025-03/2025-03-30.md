※スクール内timesの移植（2025/09/04）

んRails応用のアプリのログと見比べたら、卒制のほう、imagesにかならず空文字が挿入されるようになってるぞ？なんでだ？  
この空文字のせいで画像を変更してなくてもimagesが送信されちゃってると思うんだけど。  
https://qiita.com/keita44_f4/items/fd899beb1efdf6f1d648  
これか？  

https://api.rubyonrails.org/classes/ActionView/Helpers/FormBuilder.html#method-i-file_field

> :include_hidden - When multiple: true and include_hidden: true, the field will be prefixed with an <input type="hidden"> field with an empty value to support submitting an empty collection of files. Since include_hidden will default to config.active_storage.multiple_file_field_include_hidden if you don’t specify include_hidden, you will need to pass include_hidden: false to prevent submitting an empty collection of files when passing multiple: true.
  

> :include_hidden - multiple: trueかつinclude_hidden: trueの場合、空のファイルコレクションの送信をサポートするために、フィールドの前に空の値を持つ<input type="hidden">フィールドが追加されます。include_hiddenを指定しない場合、デフォルトはconfig.active_storage.multiple_file_field_include_hiddenとなるため、multiple: trueを指定した場合、空のファイルコレクションを送信しないようにinclude_hidden: falseを渡す必要があります。

君なのか…？  
```
Parameters: {"authenticity_token"=>"[FILTERED]", "review"=>{"title"=>"テスト3", "body"=>"テスト\r\n\r\n編集", "product_name"=>"ミッドナイトブルー", "paper"=>"", "pen"=>""}, "commit"=>"更新する", "id"=>"9"}
```
きたわあ…  
Railsの`file_field`で`multiple: true`使うときは`include_hidden: false`も渡さないとだめ。覚えた  

- 学習時間：7h/7h/734h
- 学習内容：卒制

きのうは定期お休み日の予定だったけど、画像をアップロードせずに投稿を編集すると画像が消えちゃう問題を放置したままだとキモチワルイのでそれだけやってました。  
一昨日の私は`"images"=>[""]`はおかしくないと思っていましたが、Rails応用の時のパラメータと見比べたらめちゃくちゃおかしかったです。  
画像のアップロードをしていないときは、そもそもパラメータに`images`は入ってこないので、この時点でもうおかしい。  
んで、画像投稿時のパラメータを見比べてみたら、そもそも`images`の一番最初に空文字が入っているのがおかしいってことで、ここについて調べてみました。  
[Rails7で複数画像file_filedを使っていると空画像が入る対策](https://qiita.com/keita44_f4/items/fd899beb1efdf6f1d648)  
[Rails Guide](https://guides.rubyonrails.org/configuring.html#config-active-storage-multiple-file-field-include-hidden)  
[Ruby on Rails API](https://api.rubyonrails.org/classes/ActionView/Helpers/FormBuilder.html#method-i-file_field)  
> In Rails 7.1 and beyond, Active Storage `has_many_attached` relationships will default to *replacing* the current collection instead of *appending* to it. Thus to support submitting an *empty* collection, when `multiple_file_field_include_hidden` is `true`, the [`file_field`](https://api.rubyonrails.org/v8.0.2/classes/ActionView/Helpers/FormBuilder.html#method-i-file_field) helper will render an auxiliary hidden field, similar to the auxiliary field rendered by the [`checkbox`](https://api.rubyonrails.org/v8.0.2/classes/ActionView/Helpers/FormBuilder.html#method-i-checkbox) helper.  
Rails 7.1以降では、Active Storageのhas_many_attachedリレーションはデフォルトで、現在のコレクションに追加するのではなく、現在のコレクションを置き換えます。したがって、空のコレクションの送信をサポートするために、multiple_file_field_include_hiddenがtrueの場合、file_fieldヘルパーは、checkboxヘルパーがレンダリングする補助フィールドと同様に、補助隠しフィールドをレンダリングします。
[Rails Guide](https://guides.rubyonrails.org/configuring.html#config-active-storage-multiple-file-field-include-hidden)
  
> :include_hidden - When multiple: true and include_hidden: true, the field will be prefixed with an <input type="hidden"> field with an empty value to support submitting an empty collection of files. Since include_hidden will default to config.active_storage.multiple_file_field_include_hidden if you don’t specify include_hidden, you will need to pass include_hidden: false to prevent submitting an empty collection of files when passing multiple: true.  
:include_hidden - multiple: trueかつinclude_hidden: trueの場合、空のファイルコレクションの送信をサポートするために、フィールドの前に空の値を持つ<input type="hidden">フィールドが追加されます。include_hiddenを指定しない場合、デフォルトはconfig.active_storage.multiple_file_field_include_hiddenとなるため、multiple: trueを指定した場合、空のファイルコレクションを送信しないようにinclude_hidden: falseを渡す必要があります。
[Ruby on Rails API](https://api.rubyonrails.org/classes/ActionView/Helpers/FormBuilder.html#method-i-file_field)

`空のコレクションの送信をサポートするために`のあたりがどういう意味かよくわからないけど（Qiitaの人はupdate時にすでに添付されてたファイルを置くためのフィールドと言っているが）、とにかくfire_fieldで`multiple: true`を指定すると、自動で空文字が挿入されるようになっているみたいです。  
`include_hidden: false`を指定すれば空文字が送信されなくなるので、`include_hidden: false`を指定して無事に解決しました。  
  
今日はransack導入してキーワード検索機能を作ってました。  
ransack使うとき、モデルにリレーションでつながってるモデルとか検索を許可するカラムとかいろいろ設定するのですが、孫の時はどうするんだ…？とちょっと悩みました。  
子モデルに孫モデルについてのなんやかやを書けばいいだけでした。ransackはエラーで色々教えてくれるから助かる。  
