
📖[プロを目指す人のためのRuby入門［改訂2版］ 言語仕様からテスト駆動開発・デバッグ技法まで](https://gihyo.jp/book/2021/978-4-297-12437-3)

#### クラス定義やRubyの言語使用に関する高度な話題（つづき）

- 等値を判断するメソッドや演算子を理解する  
  - `equal?`  
    object_idが等しい場合にtrueを返す。  
    まったく同じインスタンスかを判断するときにつかう。  
  
  - `==`  
    オブジェクトの内容が等しいかどうかを判断する。  
    データ型が違っても人間の目で見て自然であればtrueを返す。  
  
  - `eql?`  
    `==`と同様に等値判定を行うが、クラスによってhあ`==`よりも厳格な等値判定を行う。  
    ２つのオブジェクトがハッシュのキーとして同じかどうかを判定するのが代表的な用途。  
  
  - `===`  
    case文のwhen節の挙動。  
    ```ruby
    text = '0.-1234-5678'

    case text
    when /^\d{3}-\d{4}$/
      puts '郵便番号です'
    when /^\d{4}\/\d{1,2}\/\d{1,2}$/
      puts '日付です'
    when /^\d+-\d+-\d+$/
      puts '電話番号です'
    end
    #=> 電話番号です
    ```
    というcase文があったとして、このwhen節は内部的には `when節のオブジェクト === case節のオブジェクト`の結果を評価している。  
    パターンマッチでも`===`は使われる。  

- オープンクラスとモンキーパッチ  
  Rubyはくらすの継承に制限がないので、組込みライブラリのクラスであっても継承して独自のクラスを定義できる。  
  定義済みのクラスそのものにメソッドを追加したり、メソッドの定義を上書きしたりすることもできる。  
  Rubyのクラスは変更に対してオープンなので、オープンクラスと呼ばれることもある。  
  Ruby on Railsはオープンクラスを積極的に活用して、様々な独自の便利メソッドを組込みクラスに追加している。  
  （文字列をキャメルケースからスネークケースに変換する`underscore`メソッドやレシーバが引数の配列に含まれていればtrueを返す`in?`メソッドなど）  
  既存のメソッドを上書きすることもできる。既存の実装を上書きして自分が期待する挙動に変更することをモンキーパッチと呼ぶ。  
  外部ライブラリに軽微な不具合が有ったり、要件に合わない挙動があったときにモンキーパッチを当てて挙動を変えることがある、  
  一方で、
  - 組込みライブラリのメソッドを不適切に上書きしたため、プログラム全体の動きがおかしくなってしまった。
  - 組込みライブラリに独自のメソッドを大量に追加したが、追加した本人以外はコードを読んでも誰がどこで何の目的で定義したメソッドなのかわからず、チーム全体の開発効率が落ちた
  - 外部ライブラリのコードにモンキーパッチを当てていたが、ライブラリのバージョンアップでライブラリ本体のコードと整合性が取れなくなり、予期せぬタイミングでエラーが発生した。
  
  などの弊害が出る恐れもあるので、乱用には注意する。  
  オープンクラスやモンキーパッチを使わずに要件を満たすコードが書けないかをまず考えるようにする。  

- 特異メソッド  
  Rubyではクラス単位ではなくオブジェクト単位で挙動を変えることもできる。  
  `def オブジェクト名.メソッド名 ... end`でメソッドを定義すると、特定のオブジェクトにメソッドを定義できる。  
  特定のオブジェクトのみに紐づくメソッドを、特異メソッドと呼ぶ。  
  数値、シンボルなど、得意メソッドを定義できないオブジェクトも存在する。  
  ```ruby
  class << オブジェクト名
    def メソッド名
      # 処理
    end
  end
  ```
  のように定義することもできる。  

- クラスメソッドは特異メソッドの一種  
  クラスメソッドは、実際は特定のクラスの特異メソッド。  
  ```ruby
  # クラスメソッドを定義するコード例
  class クラス名
    def self.メソッド名
      # 処理
    end

    class << self
      def メソッド名
        # 処理
      end
    end
  end

  # 得意メソッドを定義するコード例
  sample = 'sample'

  def sample.メソッド名
    # 処理
  end

  class << sample
    def メソッド名
      # 処理
    end
  end
  ```
  クラス構文の外側でクラスメソッドを定義する方法は、特異メソッドを定義する構文により近い。  
  ```ruby
  class クラス名
  end

  def クラス名.メソッド名
    # 処理
  end

  class << クラス名
    def メソッド名
      # 処理
    end
  end
  ```
  Rubyではクラスものオブジェクトなので、クラスに特異メソッドを定義するとクラスメソッドのようにみえる。
