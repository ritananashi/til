
📖[プロを目指す人のためのRuby入門［改訂2版］ 言語仕様からテスト駆動開発・デバッグ技法まで](https://gihyo.jp/book/2021/978-4-297-12437-3)

#### 関数や定数を提供するモジュールの作成  

- モジュールに得意メソッドを定義する  
  他のクラスにモジュールを組み込まずに、モジュール単体でそのメソッドを呼び出したいようなとき、モジュール自身に特異メソッドを定義すれば、`モジュール名.メソッド名`という形でメソッドを呼び出せる。  
  モジュールはインスタンスが作れないので、`new`の必要のない単なるメソッドの集まりを作りたいケースに向いている。  
  `class << self`でも得意メソッドを定義できる。  

- module_functionメソッド  
  `module_function`メソッドを使ってメソッド名を指定すると、指定したメソッドをミックスインとモジュールの特異メソッドの両方で使えるようになる。  
  ミックスインとしてもモジュールの特異メソッドとしても使えるメソッドのことをモジュール関数と呼ぶ。  
  `module_function`メソッドを引数なしで呼び出したら、`module_function`メソッド以下のメソッドが全部モジュール関数になる。  

- モジュールに定数を定義する  
  モジュールにも定数を定義できる。  
  定義の仕方や参照の仕方はクラスとおなじ。

- モジュール関数や定数を持つモジュールの例  
  Mathモジュールはモジュール関数や定数を持つ、代表的なRubyの組込みライブラリ。  
  Mathモジュールのメソッドはモジュール関数になっていて、モジュールの特異メソッドとしてもミックスインとしても利用することができる。  
  また、自然対数の底を表すEや、円周率を表すPIという定数が定義されている。  
  他にも、Kernelモジュールの`puts`や`p`もモジュール関数になっているので、Kernelモジュールの特異メソッドとして呼び出すことができる。  

#### 状態を保存するモジュールの作成

暗さ売インスタンス変数を使って、クラス自身にデータを保持する方法があるが、モジュールでも同じことができる。  
外部ライブラリでは、そのライブラリを実行するための設定値をモジュール自身に保持させることがよくある。  
インスタンスを作って何か操作する必要がないときは、モジュールにしておいた方が他の開発者が変な勘違いをしない。  
- シングルトンパターン  
  「唯一、ひとつだけ」のオブジェクトを作る手法のこと  
  ライブラリの実行に必要な設定値などはアプリケーション全体で共通の値になることが多いため、アプリケーション内ではいつでもどこでも同じ設定値を設定したり、取得したりする必要がある。  
  なので、設定値の情報はアプリケーション内で「唯一、一つだけ」の状態になっていることが望ましい。  

#### モジュールに関する高度な話題  

- メソッド探索のルールを理解する  
  クラスでのメソッドの呼び出し順（メソッド探索の順番）は`ancestors`メソッドを使うことで確認できる。  
  順番としては、自分自身のクラス　→　2番目にincludeしたモジュール　→　最初にincludeしたモジュール　→　スーパークラス　→　さらに上のスーパークラス...と探していく。  
  最後まで探索しても探しているメソッドがなければNoMethodErrorを返す。  

- モジュールには他のモジュールをincludeする  
  includeはクラスに対してだけではなく、モジュールに対しても呼び出すことができる。  
  他のモジュールをincludeしているモジュールをクラスやモジュールにincludeすれば、そのモジュールがincludeしているモジュールも一緒にincludeされる。  

- prependでモジュールをミックスインする  
  prependという方法でモジュールをミックスインすることもできる。  
  prependでミックスインをすると、同名のメソッドがあったときに、ミックスインしたクラスよりも先にモジュールのメソッドが呼ばれる。  
  includeの場合は　includeしたクラス　→　モジュール　→　Objectクラス　の順番で呼び出されるが、  
  prependでは　モジュール　→　includeしたクラス　→　Objectクラス　の順番で呼び出される。  

- prependで既存メソッドを置き換える  
  prependを使うと、オリジナルの実装を活かして既存メソッドを置き換えることができる。  
  直接コードを書き換えることができないクラスのメソッドを拡張したいとき等に、モジュール内に同名メソッドを定義して、superでミックスインした先のクラスの同名メソッドを呼び出し、必要な拡張を記述したモジュールをprependでミックスインすると、元のクラスのメソッドを直接書き換えずにふるまいを変更できる。  
  この方法なら他のクラスに対しても簡単にお暗示変更を適用できる。  
