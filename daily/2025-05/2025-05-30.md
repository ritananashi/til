※スクール内timesの移植（2025/09/16）


:thinking_face: 

https://dev.classmethod.jp/articles/cf-s3-deliveries-use-signurl/

GPTと壁打ちしながらなんとか原因わかってきたような気がしてるけど参考資料出して♡っていっても全然資料出してくれないからほんとかどうかわからん :pleading_face:

たぶんできた？URLはCloudfrontのになってるし画像も表示されてる


- 学習時間：4h/15h/961h
- 学習内容：卒制
  

来週胃カメラやることになりました。初めての胃カメラでドキドキです。

鎮静下でやってもらえるけど苦しくないといいな。

何か見つかればいいけど、何もなかったらどうしたもんかな。
  

Cloudfrontからの画像配信できました（多分）。

Rails経由で画像を配信する（プロキシモード）方法と、S3+CloudfrontでRailsを介さずに直接画像を配信する方法があることがわからずにごちゃごちゃになっていたのが沼の原因でした。

どっちもCDNでの画像配信方法として紹介されてるから…わかんないよ…。

Rails経由で画像を配信する時とS3+Cloudfrontで配信する時と設定するオリジンが違うのですが、S3+Cloudfrontでやる時のオリジンの設定にしておきながら、Rails側ではRails経由で画像配信する設定にしてたのでS3の画像をうまくとって来れてなかったみたいです。

Railsガイドで紹介されてる方法はRails経由で画像を配信する（プロキシモード）方法なのでこっちでやりました。

`S3 -> Rails -> Cloudflare <- インターネット`という感じになっている（はず）です。

この方法は２日前になんか違うっぽいぞとやめた方法だったのですが、結局これであってたみたいです。おれがなんもわかってなかっただけだった。今もだけど。

→

参考：

[Active Storage（プロキシモード） + S3 + CloudFront でファイル配信する](https://zenn.dev/shunjuio/articles/551e4bc7a2e7fb)

[Rails 6.1 の rails_storage_proxy_url でActiveStorage のリダイレクトURL問題を解決する](https://takeyuweb.hatenablog.com/entry/2021/01/21/000000)

[Using CDN with ActiveStorage, what should be ENV\['CDN_HOST']?](https://stackoverflow.com/questions/76291653/using-cdn-with-activestorage-what-should-be-envcdn-host/76365132#76365132)

ただこのやり方、2日前にやったときはうまく画像を取ってこれてなくてやめた方法だったんですが、今日やり直したらうまくいきました。どうして。

なにか設定とか間違えてたかな～～～とは思いますが、2日前に何やってたか正直覚えてないのでわからんです。

まあ今は画像が表示されているので…。

キャッシュの関係でXへの反映は時間かかると思います（キャッシュクリアめんどうだったのでしてない）。

