※スクール内timesの移植（2025/09/16）

フォームごとにオートコンプリートの検索条件変えるの、paramsを変えて条件分岐とかでいけないか～～～？？？と思い至った。  
case省略のcase文でいけるかな

え～～～だめだオートフォーカス設定したけど効いてない～～～  
あ、いや入力フォームに設定したのは効いてる。buttonに設定したのが効いてない  
`autofocus: true`って入力フォームにしか効かない感じ！？そっか…  
> 他に即座の操作が想定される要素がない場合は、autofocus をダイアログ内の［閉じる］ボタンに追加するか、ユーザーがクリック/アクティブにして閉じることが想定される場合はダイアログ自体に追加することをお勧めします。

dialog要素に移してみた～～～どうなるかな  
dialog要素にsutofocus設定したら閉じるボタンの黒枠消えた！  
代わりにdialogの境界のところに青い線が出てますが…  
これスタイル設定したら何とかなったりしないかな。

ハァ…ハァ…フォーカスリング消えた…  
結局閉じるボタンに`focus:outline-none`を設定してそもそもフォーカスリングが表示されないようにしたよ～～～  
ここに到達するまでが遠くないですか？  
なんか最近CSSとかでやったはずの変更が消えてるんだよねーコミットしてプッシュしてるはずだけど…

`accepts_nested_attributes_for` :thinking_face:  
:thinking_face:  :thinking_face:  :thinking_face:   
https://techracho.bpsinc.jp/hachi8833/2023_09_20/132223  
http://railsguides.jp/form_helpers.html#%E8%A4%87%E9%9B%91%E3%81%AA%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B  
https://zenn.dev/ysi831/articles/0faa4c301e7d9f  
https://zenn.dev/murakamiiii/articles/5ecefb7a58d1ef  
使っていい気がする（根拠が9年位前のDHHのコメントでその後削除されずに残り続けててアップデートもされてるし）  
FormObject vs accepts_nested_attributes_for vs ダークライ  
あ、Stimulus-Componentsのサンプルコードは`accepts_nested_attributes_for`なのか  
サンプル通りにやろ  

- 学習時間：6h/17h30min/903h30min
- 学習内容：卒制

モバイルでみるとモーダル（dealog要素）の閉じるボタンにフォーカスリングが出ちゃうぞ問題、`form`に設定した`autofocus: true`はちゃんと機能したのですが、`button_to`に設定したものが機能しなくて別の手段でなんとかならんかとやってました。  
最終的に、`focus:outline-none`を設定してそもそもフォーカスリングが出ないようにしました。  
dialog要素自体に`autofocus`を設定してみたりしましたが、モーダルの境界に青い線が出てしまうのでやめました。  
でもよく考えたら、dialog要素に`autofocus`を設定した上で`focus:outline-none`を設定しても良かったのかも、と今思いました。  
また今度試してみます。が、スマホでみないと表示の確認ができないのでちょっと困った。

CSSと闘った後は、昨日実装し忘れてたインク登録フォームのオートコンプリート機能を実装してました。  
例のごとく一昨日作ったオートコンプリートを流用でサクッと終了です。  
今日は、どうにか入力フォームごとに検索条件を変えれないか…としていました。  
やっぱり、インク入力欄でBrandモデルの検索結果が出てしまうと混乱してしまうだろうし、インク登録フォームはインク名（Productモデル）とメーカー名（Brandモデル）の入力フォームがあるので、別のモデルの結果が出てしまうのは…混乱のもと！ユーザー体験的によくない…。  
なので、やっぱり理想は①検索フォームはProductとBrand両方検索、②インク名入力欄はProductのみ検索、③メーカー名入力欄はBrandのみ検索、です。  
とはいえ、どのフォームに入力されたか、はsubmitを押してコントローラに情報が送られてくるまでわかりません。  
しかし、オートコンプリートは入力した段階で、デフォルトで`q`パラメータを送ります。  
ここで思い出したのですが、Stimulus-autocompleteは`data-autocomplete-query-param-value`を設定するとパラメータをカスタマイズできます。  
これを使えば、送信されるparamsのキーで条件分岐できるのでは？と思ったので、やってみました。
```ruby
  def autocomplete
    case
    # 検索フォーム用
    when params[:q]
      @q = params[:q]
      @products = Product.ransack(name_cont: @q).result(distinct: true)
      @brands = Brand.ransack(name_cont: @q).result(distinct: true)
    # インクのみ検索（投稿フォーム入力欄＆インク登録欄）
    when params[:product_name]
      @q = params[:product_name]
      @products = Product.ransack(name_cont: @q).result(distinct: true)
    # メーカー名のみ検索（インク登録欄）
    when params[:brand_name]
      @q = params[:brand_name]
      @brands = Brand.ransack(name_cont: @q).result(distinct: true)
    end
    render layout: "main_only"
  end
```
`case`文は、`case`の式を省略すると、`when`節の条件式が偽ではない最初の式を返す、そうです。  
https://docs.ruby-lang.org/ja/latest/doc/spec=2fcontrol.html#case  
これで、送られてきたパラメータのキーで動きを変えらえるのでは…と思い試してみたところ、うまくいきました :v:   
もっとほかにいい手段があるかもしれませんが、とりあえずこれで行こうと思います。

オートコンプリートが終わったので、次はインクレシピ入力欄を作ります。  
インクレシピ入力欄は、オリジナルインクが選択されたときに、クリックで入力欄を増やせるやつで実装しようと考えてます。  
https://www.stimulus-components.com/docs/stimulus-rails-nested-form  
`accepts_nested_attributes_for`を使って、親子モデル両方同時に保存できるようですが、調べていたらどうも非推奨？みたいな話もあって、ちょっとだけ調べてました。  
非推奨の論拠が[2016年のDHHのコメント](https://github.com/rails/rails/pull/26976#discussion_r87855694)らしく、これ以外は具体的な悪例含めて見つかりませんでした。  
使いたくないと考えている人は多くいるけど、RailsとしてはRails7でも`accepts_nested_attributes_for`のアップデートがあったり、具体的な代替案や削除計画があるわけではない…ようでした（[参考](https://zenn.dev/ysi831/articles/0faa4c301e7d9f)）。  
何か情報を知っている人がいれば教えていただけると助かります。  
自分は特に複雑なことをやるわけではない…と思うし、Stimulus-Componentsのサンプルコードも`accepts_nested_attributes_for`を使っているので、とりあえずサンプルコードのままやってみて、あまりにつらいならFormObject等、別の手段を考えてみようと思います。

