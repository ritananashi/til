※スクール内timesの移植（2025/09/16）

モバイルヘッダーで未読通知の表示をどうするか全然考えてなくていま悩んでる

インク選択画面からフォームにインクの名前反映できなくなってるー！なぜ！？  
あ、本番環境の話です  
あれ、ローカルもダメになってる…  
この辺触ってないからいつからなってたのかがわからんな  
5/13まではできてた…そのあとか  
オリジナルを入力したときのインクレシピ入力欄もデフォの入力欄消えてらーなんでや  
入力フォームの追加できない！いよいよなんか変だな！？  
レビューフォーム周りでまともに動いてるStimulusオートコンプリートだけだぞ  
レシピ入れたレビューの編集画面でレシピの入力欄が出てこない、と…。  
本番環境ではオリジナル入力時にインクレシピ入力欄がちゃんと出てくる  
あれ、今度はローカルでもインクレシピ入力欄が出てくるぞ…  
stimulusのインク選択のメソッドにconsole.logを仕込んでみたけどログ出力なし…動いてないな。  
インクレシピ入力欄を表示させるメソッドにconsole.log仕込んだらログ出力あり。  
わかったー！！通知画面用にヘッダーにモーダル用のTurbo_frame仕込んだからそっちで反応してるんだ！！！！！  
だからform内にモーダルが生成されてなくてStimulusが反応しないんだ！！！  
ID変えるしかないかあ…  
ちゃんと　DOMを　みよう  
IDが違うだけのモーダルフレームパーシャル作るのいやすぎて、最初にマッチしたIDを使う性質を利用しようとしてるけどこれ大丈夫か

- 学習時間：5h/8h/933h30min
- 学習内容：卒制

今日は割と調子がよくて結構できた。  
薬が効いてきてるのかもしれない。

通知機能をとりあえず終わらせた。  
ポリモーフィック関連付けで通知機能を作る記事は色々あったけど、さくぴさんのコードが一番脳に優しくてわかりやすかったので参考にさせていただきました。ありがとうございます。  
そのあとに投稿フォームのインク選択画面からインクを選択してフォームに反映させるJSが動いてなくてなんでや！と原因を探していました。  
モーダルはTurbo_frameを使っていて、モーダル用のやつを全部使いまわしていています。  
で、どのページからでも通知用のモーダルを開けるように、ヘッダーにTurbo_frame_tagを仕込んだのが原因でした。  
どうも同じIDのTurbo_frame_tagがあるときは一番最初に見つかるやつを使うようです。  
このために、deta-controllerのあるdiv内にインク選択モーダルが生成されず、インク選択JSが動かなかったようです。  
ヘッダーに仕込んだTurbo_frame_tagをapplication.html.erbのメインコンテンツ部分の下に配置してとりあえず対応しました。  
IDを変更するべきだとは思いますが、モーダルの共通部分をパーシャル化して使っていて、IDを変えるとなると、IDが違うだけの新しいパーシャルを作らないといけない…のが嫌だったのでとりあえずこの実装にしています。  
問題が起こるようなら…変えます…。  
あと、インクレシピを登録してあるレビューの編集画面で、デフォルトでインクレシピ入力欄が出てこない問題と、インクレシピを登録してあるレビューの編集画面でインクレシピ入力欄を追加したら未入力の入力欄が出てくるのではなく、既存のインクレシピと同じ入力欄が全部でてきちゃう問題を何とかします。  
デフォルトでインクレシピ入力欄が出てこない問題はconnectに仕込めばよさそうですが、インクレシピ入力欄を追加したら未入力の入力欄が出てくるのではなく、既存のインクレシピと同じ入力欄が全部でてきちゃう問題は、未入力のインクレシピ入力欄をデフォで一個表示させる実装と両立できなさそうな気がしています。どうしようね。
