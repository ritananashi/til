※スクール内timesの移植（2025/09/16）


デフォルト入力欄と編集画面での新規追加両立できた！新規入力欄として追加される方の`fields_for`がどっちかわかってなかっただけだった
というわけで昨日見つけた問題3つは修正完了


- 学習時間：4h/12h/937h30min
- 学習内容：卒制
  

最後のHRまで頑張れるかなと思いましたが、やっぱりしんどくなってきたので無理そうです :sob: 

21時までは…もたない…。

卒業式で…会おう…。
  

昨日の不具合3つの修正おわりました。

デフォルトでインクレシピ入力欄が出てこない問題はconnectにインク入力欄のvalueに「オリジナル」が入っているかを判定して、インクレシピ入力欄を隠してる`hidden`を消せばOKでした。

インクレシピ入力欄を追加したら未入力の入力欄が出てくるのではなく、既存のインクレシピと同じ入力欄が全部でてきちゃう問題に関しては、新規で追加される`fields_for`がどれかわかってなかったせいでした。

Rails nested formはこんな感じのビューを使うのですが
```
<%= form_with model: @user, data: { controller: 'nested-form', nested_form_wrapper_selector_value: '.nested-form-wrapper' } do |f| %>
  <template data-nested-form-target="template">
    <%= f.fields_for :todos, Todo.new, child_index: 'NEW_RECORD' do |todo_fields| %>
      <%= render "todo_form", f: todo_fields %>
    <% end %>
  </template>

  <%= f.fields_for :todos do |todo_fields| %>
    <%= render "todo_form", f: todo_fields %>
  <% end %>

  <!-- Inserted elements will be injected before that target. -->
  <div data-nested-form-target="target"></div>

  <button type="button" data-action="nested-form#add">Add todo</button>

  <%= f.submit 'Save todos' %>
<% end %>
```
このままだとデフォルトで新規の入力欄を出してくれないので、[公式のissue](https://github.com/stimulus-components/stimulus-components/issues/62)で見つけた対応をして、デフォルトで新規の入力欄を一つ表示するようにしていました。
```
# in view, add `@user.todos` into the fields_for form. I did this also to make sure the 
# instances were attached to the nested form builder so I could access them later.
  <%= f.fields_for :todos, @user.todos do |todo_fields| %>
    <%= render "todo_form", f: todo_fields %>
  <% end %>

# In the controller, pre-populate an associated object (in this case a todo). Here in the edit/update route because
# that's what's in the docs, but I was using it in new/create as well.
class UsersController < ApplicationController
  def new
    @user = User.new
    @user.todos.build
  end
  # ...
  # Existing controller code in docs
end
```
ただ、この`@user.todos`は、両方の`fields_for`に入力するのかと思ってやってました。

新規で入力欄を追加する方の`fields_for`に`@user.todos`を設定していたので、登録されてるインクレシピがすでに入力されてる入力欄が生成されていたようです。

`template`内の`fields_for`がこの追加ボタンを押したときに新規で追加される入力欄になるようで、こちらを`Todo.new`に戻したところ、何も入力されてない新規の入力欄を追加できるようになりました。

また、`template`外のほうは、@user.todosを記述しておけば、新規投稿時には（登録されてるレシピがないので）空白の入力欄が、編集時には登録されてるレシピが反映された入力欄がデフォルトで出てきてくれます。

というわけで修正おわり！
  

あとはページネーション実装してました。

kaminari使おうかと思ったけど、そういえば前に[Rails: Pagy gemでRailsアプリを高速ページネーション（翻訳）](https://techracho.bpsinc.jp/hachi8833/2021_07_13/57481)という記事を読んだことを思い出して、Pagyにしてみました。

無限スクロールやろうかなと思ったけど、無限スクロールだと逆にUX悪くなるタイプのアプリだなと思ったのでやっぱりやめました。

Pagyの使用感は公式Docわかりにくいよ以外は困ったことは特にないかなと思います。

ページネーションのリンク、デフォルトだと思ってたやつがモジュールで追加するヘルパーメソッドなのはいいんだけどその情報に到達するのがちょっと大変でした…。公式Doc、どこに何が書いてるかわかりにくいよお！

