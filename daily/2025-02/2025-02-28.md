
📖[プロを目指す人のためのRuby入門［改訂2版］ 言語仕様からテスト駆動開発・デバッグ技法まで](https://gihyo.jp/book/2021/978-4-297-12437-3)

#### 定数についてもっと詳しく

定数はクラスの外部から直接参照できる。  
`クラス名::定数名`  
と書くとクラスの外部から定数を参照できる。  
定数をクラスの外部から参照させたくないときは`private_constant`で定数名を指定する。  
Rubyではメソッド内にスコープを限定した定数は定義できないので、メソッドの中で定数を定義しようとするとエラーになる。  
なので、定数の定義は必ずクラス構文の直下、もしくはトップレベルで行わなければならない。  
Rubyの定数定義は式になっているのでそれ自体が値を返す。  
なので、例えば配列を定数として定義しつつ、その要素も定数として定義することができる。  
```ruby
COLORS = [
  GREEN = 0,
  YELLOW = 1,
  RED = 2
]

# クラス名::GREENなどで要素を呼び出せる
```
定数にはメソッドや条件分岐を使った動的な値も代入できる。  

- 定数と再代入  
  Rubyの定数は、そのままの状態だと再代入が出来てしまうので、定数の値を後から書き換えできてしまう（警告は出る）。  
  `クラス名.freeze`とすることで、外部からのクラスの変更を受け付けなくなる。  
  普通は定数を上書きする人はいないだろうと思われているので、わざわざクラスを`freeze`させることは少ない。  
  クラス内でも`freeze`を呼べば再代入を防ぐことができるが、そのあとでメソッドの定義も出来なくなってしまうので、`freeze`を呼ぶことはまずない。  

- 定数はミュータブルなオブジェクトに注意する  
  再代入をしなくても、ミュータブルなオブジェクトであれば定数の値をかえることが出来てしまう。  
  文字列を`upcase!`などで破壊的に変更したり、配列に新しい要素を追加したりしても、とくに警告は出ずに定数を変更できてしまう。  
  定数の値を`freeze`することで、上記のような変更を防ぐことができる。  
  配列やハッシュを`freeze`すると、配列やハッシュそのものへの変更は防止できるが、配列やハッシュの各要素は`freeze`できないので、要素にも`freeze`をつけて変更できないようにする必要がある。  
  `SOME_NAMES = ['Foo', 'Baa', 'Buz'].map(&:freeze).freeze`のようにすると、配列の各要素を`freeze`して、最後に配列を`freeze`して変更不可能にできる。  
  イミュータブルなオブジェクトは、`freeze`しなくても変更不可能。  

#### さまざまな種類の変数  

Rubyには、ローカル変数とインスタンス変数以外にも
- クラスインスタンス変数
- クラス変数
- グローバル変数
- Ruby標準の組込み変数（特殊変数）

がある。  
使用頻度は低い。  

- クラスインスタンス変数  
  クラスインスタンス変数は、インスタンスの作成とは無関係に、クラス自身が保持しているデータ（クラス自身のインスタンス変数）のこと。  
  クラス構文の直下や、クラスメソッドの内部で@で始まる変数を操作すると、クラスインスタンス変数にアクセスしていることになる。  
  ```ruby
  class Product
    @name = 'Product'
    # クラスインスタンス変数

    def self.name
      @name
      # クラスインスタンス変数を参照
    end

    def initialize(name)
      @name = name
      # インスタンス変数
    end

    def name
      @name
      # インスタンス変数を参照
    end
  end
  ```
  インスタンス変数は同じ変数名ならスーパークラスでもサブクラスでも同一のインスタンス変数が参照されるが、クラスインスタンス変数は同名であってもスーパークラスとサブクラスで異なる変数として参照される。  
  ややこしい。  

- クラス変数  
  変数の前に`@@`のように`@`を二つつけると、クラス変数となる。  
  クラスインスタンス変数はスーパークラスとサブクラスで別々の変数として参照されるが、クラス変数は、スーパークラスとサブクラスでも同一の変数として代入・参照可能。  
  クラス変数の内容が変更されると、他のクラスや他のインスタンスのメソッドも実行結果が変わる。  
  クラス変数はライブラリの設定情報を格納する場合などに使われることがある。  

- グローバル変数と組込み変数  
  `$`で変数名を始めるとグローバル変数になる。  
  グローバル変数はクラスの内外を問わず、どこからでも代入、参照ができる。  
  グローバル変数の乱用は理解しづらいプログラムを生み出す原因になるので、なるべく仕様は避けた方がいい。  
  `$`で始まるいくつかの変数は組込み変数や特殊変数としてRuby自身によって最初から用途を決められている（正規表現の実行結果を格納する`$1`とか）。  
  `$`ではじまる組込み変数や特殊変数は別の方法でも同じ情報を取得できることが多いので、極力使用は避けた方がいい（ほかの人が理解しにくくなるので）。