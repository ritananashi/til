
:open_book:教材：[パーフェクトRuby on Rails【増補改訂版】](https://gihyo.jp/book/2020/978-4-297-11462-6)

※12/13はカリキュラムのみ、12-14は休み

### ユースケースとモデル（つづき）

比較的単純なアプリケーションでは、あるテーブルのある種類のデータ操作は1つのユースケースでしか行われない。  
RailsはURLで表されるリソースをデータベースのテーブルと一対一に対応させていて、CRUD操作を通じてユーザとやり取りすることでユースケースを構成するので、あるモデルのCRUD操作は対応するテーブルのデータ操作だけでなく、あるユースケースの一部または全体の処理の呼び出しにも対応する。  
RailsではモデルのCRUD操作の前後に実行される処理を追加することでユースケースを実現するアプローチをとっており、このアプローチの代表的なものがバリデーションとコールバックである。  
これらを利用してユースケースのロジックをscaffoldで生成されたモデルに追加していくだけで、比較的単純なアプリであればすぐに作れるようになっている。  
ユースケースのロジックとは、対象のユースケースがなければそもそも存在しないようなふるまいのこと（ユーザー登録が完了したらウェルカムメールを送信する、等）。
しかし、こうしたアプローチはアプリケーションへの機能要求が複雑になるにつれて、あるテーブルのある種類のデータ操作が複数のユースケースで行われるようになり、単純なバリデーションやコールバックではユースケースを実現できなくなってしまって、機能しなくなっていってしまう。  
また、機能要求が複雑になるにつれて、対応するテーブルが存在しないリソースのCRUD操作を要求する必要がでてきてしまったりして、URLで表されるリソースとデータベースのテーブルの一対一の関係も崩れていってしまう。  

### データベースと紐づかないモデルを作る

アプリケーションへの機能要求が複雑になると、Railsのアプローチが機能しなくなる問題に対処するために、新しいレイヤーを導入してユースケースのロジックをモデルから分離するという方法が提案されている。  
ActiveModelを利用して、ユースケースのロジックを実装するレイヤーを導入することで、もでるやコントローラーの肥大化を避けることができるが、一方で、「レール」から外れることになるので、Railsから受けられる恩恵は小さくなってしまう。  
なので、ActiveModelをつかってｍモデルと同じようにコントローラーやビューのメソッドとの連携ができるようにする。  

ActiveModelはモデルに関するモジュール群を提供するライブラリであり、ActiveRecord の実装に利用されており、ActiveModelを利用することで、自分で定義した素のRubyクラスにもActiveRecordと同等のインターフェースや機能を追加できるため、データベースと紐づかないモデルを作ることができる。  
`ActiveModel::Attributes`は型を持つ属性の定義を容易にしてくれるモジュールで、ActiveRecordの属性のように、方に合わない値を設定すると自動で型変換を行ってくれる。  
`ActiveModel::Attributes`をincludeすると、属性を定義するためのattributeメソッドを利用できるようになる。  
`ActiveModel::Callbacks`は、コールバック機能の実装を容易にしてくれるモジュール。`ActiveSupport::Callbacks`でも同じことはできるが、ActiveRecordのようにコールバックを設定したいときはこっちのほうがいい。  
`ActiveModel::Serialization`はオブジェクトのシリアライズ機能の実装を容易にしてくれるモジュールで、オブジェクトをハッシュに変換するserializable_hashメソッドだけが提供されている。  
JSON形式でのシリアライズを実装した`ActiveModel::Serializers::JSON`もある。  
`ActiveModel::Validations`は属性のバリデーション機能を容易にしてくれるモジュール。データベースのレコードを参照するヘルパーを除いて、ActiveRecordと同じバリデーションヘルパーを提供する。  
before_validation、after_validationコールバックを利用するときは、さらに`ActiveModel::Validations::Callbacks`をincludeする。  
`ActiveModel::Model`はActiveModelが提供するモジュール群の一部をまとめたモジュールで、複数のモジュールを組み合わせて、コントローラやビューのメソッドとの連携に必要なインターフェースを提供する。  
`ActiveModel::Model`をincludeするだけで、オブジェクトをコントローラやビューのメソッドで利用したり、ActiveRecordみたいにオブジェクトを属性のハッシュで初期化したり、バリデーションを設定して実行できるようになる。
