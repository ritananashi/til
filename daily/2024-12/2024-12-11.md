
:open_book:教材：[パーフェクトRuby on Rails【増補改訂版】](https://gihyo.jp/book/2020/978-4-297-11462-6)

※12/9、12/10はカリキュラムのみ

### 値オブジェクト

エンティティとは属性の値にかかわらず一意に識別されるオブジェクトのことで、エンティティは識別子と呼ばれる同一性を識別するための情報を持っている。  
あるオブジェクトの持っている属性の値が、何らかの理由で変更されても、識別子が同じであれば変更前と変更後のオブジェクトは同じものとして扱われる。  
あるオブジェクトと同じ属性の値を持っているオブジェクトがあったとしても、識別子が違えば別のオブジェクトと認識される。  
属性の同一性は、オブジェクトが異なっていたとしても、それぞれが持つ意味に違いはなく、何であるかが重要であるため、値が同じであればアプリケーション上は同じものとして扱ってよい。  
こうしたオブジェクトを値オブジェクトと呼ぶ。  
Railsのモデルのインスタンスはidを識別子とするエンティティで、モデルはアクティブレコードを実装したものであることから、属性の型はデータベースのデータ型をData、Integer、Stringなどの対応するデータ型へと変換したもの。  
この中にはドメインの重要な概念が含まれていることがあるため、関連する属性とふるまいを値オブジェクトとして定義すると、ドメインロジックがうまく表現できる。  
（値オブジェクトについて → [DDD基礎解説：エンティティ、値オブジェクトってなんなんだ](https://little-hands.hatenablog.com/entry/2018/12/09/entity-value-object)）

ある属性の値がある特定の意味を持った値であるかを判別するロジックをモデルに実装していくと、すぐにモデルが肥大化していってしまう。  
また、別のモデルにも同じような属性と値があるとしたとき、Railsには複数のモデルから扱われる特定の意味を持った値を実装するレイヤーが用意されていないため、ロジックをどこに実装するべきかが難しい。  
こうしたときは、値オブジェクトを導入するとよい。  
models/に値オブジェクト専用のファイルを用意して、元のモデルから特定の意味を持った値に関するロジックを分離することで、特定の意味を持った値に関するロジックが増えたとしても、モデルの肥大化を避けられる。  
また、ロジックを複数のモデルの間で簡単に再利用することができるようになる。  
質の高いアプリケーションを開発するには、ドメインモデルを正確に抽出すること以外にも、抽出したドメインモデルを実装に正確に反映させることも重要。  
値オブジェクトを導入すると、ドメインモデルをより正確に実装に反映できる。  

Railsには、モデルの属性を値オブジェクトとして表現するための仕組みとして、`composed_of`が用意されている。  
第一引数に値オブジェクトを用いる属性名を指定するが、指定した属性名をclassifyしたものが、値オブジェクトのクラスメイトみなされる。  
mappingオプションでモデルと値オブジェクトの属性の対応関係を配列で指定する。  
配列の第一要素にはモデルの属性名、第二要素には値オブジェクトの属性名を指定する。  
`composed_of`を使うと、値オブジェクトのアクセサメソッドが簡単に定義出来たり、レコードの検索条件を値オブジェクトで指定できる。  
他にも、オプションを指定することで、定義されるアクセサメソッドの挙動を細かく変更できる。  
