
:open_book:教材：[パーフェクトRuby on Rails【増補改訂版】](https://gihyo.jp/book/2020/978-4-297-11462-6)

### 環境によって可変する設定値や秘匿情報の管理

コンテナは完結したファイルシステムの状態でパッケージングされて、その状態のまま起動するのがメリットであるため、ファイルベースで書く環境用のdatabase.ymlや設定ファイルを配置してから起動するという方式はなじまない。  
無理やり実現できないことはないが、コンテナを利用するメリットを大きく損ねることになる。  
なので、起動時に可変する設定値を注入する。そのために環境変数を利用する。  
DBなどの接続先や認証情報以外の秘匿情報については、credentials.yml.encを利用できる。  
credentials.yml.encは暗号化されているのでそのままコンテナイメージに含めてしまい、credentials.yml.encのmaster keyを環境変数として実行時に渡すことでコンテナ起動時に秘匿値を複合化して読み込むことができる。  
開発環境では環境変数はdocker-compose.ymlに記述することで簡単に読み込むことができる。  

環境変数化することで、コンテナイメージを複数パターン作ってそれぞれのアクセス権限を管理する必要がなくなる。
しかし一方で、環境変数に指定する値をどこで管理するのかという問題が生じる。  
柔軟で安全な権限管理を行うにはこれだけでは十分ではない。  

開発しているアプリケーションのデプロイ先がAWSやGCPなどのクラウドプラットドームである場合は、権限管理をプラットフォーム側に任せることができる。  
AWS、GCPともにKey Management Serviceというサービスがあり、この基盤を利用することでクラウドサービス上のIAMをベースに権限管理を行いつつ暗号化・復号化を実現できる。  
2021年時点でAWS、GCP両方で利用可能な手法は、KMSで作成した鍵情報を元にファイルを暗号化してS3もしくはGCSにファイルとして保存しておく方法がある。  
コンテナ起動時にラッパースクリプトを実行するようにしておいて、ファイルをストレージからダウンロードしつつ復号化し、アプリケーションを起動する、という方法。  
AWSであればS3の機能問いs手組み込まれており、コマンドで簡単に暗号化して保存できる。  
鍵管理をKMSに任せることでIAMで秘匿情報へのアクセス権限を管理できるようになる。  
開発者がチームから離脱したり新しく参加したりするときの権限の着脱が一か所で完結するようになるし、インスタンスやコンテナホストサービスと紐づけたIAMロールを用いて秘匿情報にアクセスできるようになる。  
クラウドサービス上のインスタンス構成やコンテナホストサービスの攻勢を環境に合わせて変更しておくだけで、自動的に必要な秘匿情報にだけアクセスできるようになる。  
AWSにはSecret ManagerやParameter Storeというしくみもあり、これらを利用すると、パラメーター単位でアクセス権限をコントロールしつつ暗号化を行うことができるようになり、さらに細かい権限管理やアクセス証跡を記録することができるようになる。  
AWSのParameter Storeはディレクトリのパスのように名前を設定しておくと、特定のパス以下をまとめて取得する機能がある。
