※スクール内timesの移植（2025/09/16）


画像なしで投稿するとなぜかレビュータイトルと本文が認識されなくなってるんじゃが！？

あっすいません画像変換用のメソッドの中でparamsを返す位置がおかしかっただけでした

全然気づいてなかったけどインク登録画面でバリデーションエラー起こったらフォームをレンダリングしないでエラー画面に飛ばされちゃうや

products/newじゃなくてproducts/に遷移してる？なんで？

turbo framesの必要な記述が足りてなかった + `find_or_create_by!`で例外発生させてたのがダメだったっぽい。  
ちょうどトランザクション対応してるとこで`ActiveRecord::Base.transaction`のブロック内に入れてるから`find_or_create_by`に変更したらちゃんとなった。


- 学習時間：6h/12h/798h
- 学習内容：卒制
  

昨日の続きでユーザーアイコンもリサイズしてwebp形式で保存するのと、トランザクション対応してました。

昨日は`@review.images.attach`したら`imagesなんてメソッドないよ`って怒られてたんですけど、今日`@user.avatar.attach`したら怒られなかったので不思議だなあと思います。

本リリ落ち着いたらどこかでまた実験しようかな。

`avatar`はuserモデルで`has_one_attached`してるので、deviseのregistrations_controller.rbのupdateメソッドをオーバーライドして実装しました。

といっても大変なことは特にしてなくて、コメントアウト外して`super`の下に`params[:user][:avatar]`があったら画像変換して変換したものを`attach`する記述を追加しただけです。簡単！

画像が一枚だけなら`@user.avatar.attach(io: 変換したtempfile, filename: "#{元のファイル名}.webp", content_type: "image/webp")`みたいな感じでattachできるから楽でした。
  

あとはトランザクション対応をしていました。

インクを新規登録するときにメーカー名を入力してもらうんですけど、DBになかったら新しくデータを作成する`find_or_create_by!`のところとかをトランザクション対応したほうが良いと講師の方からご指摘いただいたのでやってました。

あと、データを新しく作ってるわけじゃないけどレビューのcreate、」update、destroyもやっときました。一応ね。

トランザクション対応事態は`ActiveRecord::Base.transaction do`のブロック内に処理に失敗したらロールバックしたい処理を入れるだけです。

そのあと、開発環境でインクの新規登録に失敗したときを試してみたら、フォームを再レンダリングしてバリデーションエラーメッセージを表示するのではなく、`/product`に遷移してエラー画面が表示されてしまう、という状態になっていたことが発覚しました。

新規登録のform_withに`data-turbo=true`を設定していなかったのと、トランザクション内で`find_or_create_by!`を使って例外が発生するとエラー画面に飛ばされちゃうみたいだったので、`find_or_create_by`に変更したらフォームを再レンダリングしてくれるようになりました。

トランザクション周りもTurbo Framesもよくわかってないこと多いのでまた今度調べます。べんきょう！
