※スクール内timesの移植（2025/09/16）


たぶん
```
where((検索カラム1 ILIKE 検索ワード1)or(検索カラム2 ILIKE 検索ワード1)or(検索カラム3 ILIKE 検索ワード1)...)and((検索カラム1 ILIKE 検索ワード2)or(検索カラム2 ILIKE 検索ワード2)or(検索カラム3 ILIKE 検索ワード2)...)
```
みたいなクエリになればやりたい検索ができるのかな…？クエリよくわかんないけど…。

今のor検索でも支障はないといえばないからな～～～
今はこんなん
```
Review Load (0.8ms)  SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
 WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."title" ILIKE '%青%')
  OR ("reviews"."body" ILIKE '%webp%' OR "reviews"."body" ILIKE '%青%'))
   OR ("products"."name" ILIKE '%webp%' OR "products"."name" ILIKE '%青%'))
    OR ("reviews"."paper" ILIKE '%webp%' OR "reviews"."paper" ILIKE '%青%'))
     OR ("reviews"."pen" ILIKE '%webp%' OR "reviews"."pen" ILIKE '%青%'))
      OR ("brands"."name" ILIKE '%webp%' OR "brands"."name" ILIKE '%青%'))
       ORDER BY "reviews"."created_at" DESC
```


ただこれだと検索ワードが増えるほど検索結果も増えちゃうからな…

メモ：groupingsとcombinatorについて調べる

キター！！！
```
Review Load (0.7ms)
  SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
   WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."body" ILIKE '%webp%')
    OR "products"."name" ILIKE '%webp%')
     OR "reviews"."paper" ILIKE '%webp%')
      OR "reviews"."pen" ILIKE '%webp%')
       OR "brands"."name" ILIKE '%webp%')
        AND ((((("reviews"."title" ILIKE '%青%' OR "reviews"."body" ILIKE '%青%')
         OR "products"."name" ILIKE '%青%')
          OR "reviews"."paper" ILIKE '%青%')
           OR "reviews"."pen" ILIKE '%青%')
            OR "brands"."name" ILIKE '%青%'))
             ORDER BY "reviews"."created_at" DESC
```

カテゴリの絞り込みが効いてない～～～

groupingのハッシュにカテゴリを追加すれば行けたわ


- 学習時間：5h/29h/815h
- 学習内容：卒制
  

普段より早いけど、今日はこの後20時からのイベント参加あるので今書いちゃいます。

複数検索ワードでのAND検索に再チャレンジしてました。

検索には`gem ransack`を使用しているのですが、ransackのシンプルモードで素直に記述すると、たぶん`指定するカラム名1_or_指定するカラム名2_or_指定するカラム名3_cont_all`が複数カラムに対するAND検索になると思います。

`指定するカラム名_or_指定するカラム名`は`指定するいずれかのカラム`に値が入っているかの記述で、`_cont_all`が部分一致検索のAND検索の記述です。

発行されるクエリは以下のようになります（見やすいように適当に改行入れてます）。
```bash
SELECT COUNT(*) 
FROM (SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id" 
WHERE (((((("reviews"."title" ILIKE '%webp%' AND "reviews"."title" ILIKE '%青%')
 OR ("reviews"."body" ILIKE '%webp%' AND "reviews"."body" ILIKE '%青%'))
  OR ("products"."name" ILIKE '%webp%' AND "products"."name" ILIKE '%青%'))
   OR ("reviews"."paper" ILIKE '%webp%' AND "reviews"."paper" ILIKE '%青%'))
    OR ("reviews"."pen" ILIKE '%webp%' AND "reviews"."pen" ILIKE '%青%'))
     OR ("brands"."name" ILIKE '%webp%' AND "brands"."name" ILIKE '%青%'))
      ORDER BY "reviews"."created_at" DESC) subquery_for_count
SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
 WHERE (((((("reviews"."title" ILIKE '%webp%' AND "reviews"."title" ILIKE '%青%')
  OR ("reviews"."body" ILIKE '%webp%' AND "reviews"."body" ILIKE '%青%'))
   OR ("products"."name" ILIKE '%webp%' AND "products"."name" ILIKE '%青%'))
    OR ("reviews"."paper" ILIKE '%webp%' AND "reviews"."paper" ILIKE '%青%'))
     OR ("reviews"."pen" ILIKE '%webp%' AND "reviews"."pen" ILIKE '%青%'))
      OR ("brands"."name" ILIKE '%webp%' AND "brands"."name" ILIKE '%青%'))
       ORDER BY "reviews"."created_at" DESC
```
複数ワードを入れると、上記の通り`指定している各カラムにすべての検索結果が含まれるか`を探してしまいます。

これがOR検索（`指定するカラム名1_or_指定するカラム名2_or_指定するカラム名3_cont_any`）だと、下記のようになります。
```bash
SELECT COUNT(*) FROM (SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
 WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."title" ILIKE '%青%')
  OR ("reviews"."body" ILIKE '%webp%' OR "reviews"."body" ILIKE '%青%'))
   OR ("products"."name" ILIKE '%webp%' OR "products"."name" ILIKE '%青%'))
    OR ("reviews"."paper" ILIKE '%webp%' OR "reviews"."paper" ILIKE '%青%'))
     OR ("reviews"."pen" ILIKE '%webp%' OR "reviews"."pen" ILIKE '%青%'))
      OR ("brands"."name" ILIKE '%webp%' OR "brands"."name" ILIKE '%青%'))
       ORDER BY "reviews"."created_at" DESC) subquery_for_count
SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
 WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."title" ILIKE '%青%')
  OR ("reviews"."body" ILIKE '%webp%' OR "reviews"."body" ILIKE '%青%'))
   OR ("products"."name" ILIKE '%webp%' OR "products"."name" ILIKE '%青%'))
    OR ("reviews"."paper" ILIKE '%webp%' OR "reviews"."paper" ILIKE '%青%'))
     OR ("reviews"."pen" ILIKE '%webp%' OR "reviews"."pen" ILIKE '%青%'))
      OR ("brands"."name" ILIKE '%webp%' OR "brands"."name" ILIKE '%青%'))
       ORDER BY "reviews"."created_at" DESC
```
いずれかのカラムにいずれかの検索ワードが入っているかを探しているので、`_all`を指定するよりは検索結果が出てきますが、検索ワードが増えると検索結果もどんどん増えてしまいます。

私が今回やりたいのは、`すべての検索ワードが、いずれかのカラムに含まれているもののみを抽出する`検索です（AND検索）。

ようは`たけのこ　きのこ`と検索を掛けたときに、`title: たけのこ, body: きのこ`とか、`title: きのこ, name: たけのこ`とかを出したくて、`title: きのこ`だけとかは出したくないってことです。

色々調べて、ransackの`groupings（条件グループ）`に到達しました。

参考文献：
[Ransackで簡単に検索フォームを作る73のレシピ](https://nekorails.hatenablog.com/entry/2017/05/31/173925#038-ggroupings---%E6%9D%A1%E4%BB%B6%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97)
[【Rails】ransackで複数ワードAND検索を作ってみた。](https://qiita.com/Jackson123/items/2c3c73da6679db6f53c7)

条件グループは、検索条件をグループで分けて、各グループをANDかORで検索できるってこと見たいです。

`ransack()`の引数に`groupings: グループに分けたハッシュ`を渡せばいいっぽい。
```ruby
@q = ["webp", "オリジナル"]
@grouping = @q.each_with_index.reduce({}){|hash, (word, i)| hash.merge(i.to_s => { review_search_cont: word })}
#=> {"0"=>{:review_search_cont=>"webp"}, "1"=>{:review_search_cont=>"オリジナル"}, "Category_refine"=>{:product_category_id_eq=>"1"}}のようにグループ分けする。reduceとかの細かいメソッドは調べてね。
# この変数を下記のようなransackのコードに渡す
@reviews = Review.ransack({ combinator: "and", groupings: @grouping_word }).result(distinct: true).includes(:user, product: :brand).order(created_at: "DESC")
```
`review_search`はransack aliasです。カラムの指定長いからエイリアス作りました。

`combinator: "and"`はAND検索をするように指定しています。ここを`or`にするとOR検索になります。
発行されるクエリは以下の通りです。
```bash
SELECT COUNT(*) FROM (SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id" 
WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."body" ILIKE '%webp%')
 OR "products"."name" ILIKE '%webp%')
  OR "reviews"."paper" ILIKE '%webp%')
   OR "reviews"."pen" ILIKE '%webp%')
    OR "brands"."name" ILIKE '%webp%')
     AND
      ((((("reviews"."title" ILIKE '%オリジナル%' OR "reviews"."body" ILIKE '%オリジナル%')
       OR "products"."name" ILIKE '%オリジナル%')
        OR "reviews"."paper" ILIKE '%オリジナル%')
         OR "reviews"."pen" ILIKE '%オリジナル%')
          OR "brands"."name" ILIKE '%オリジナル%')
           AND
            "products"."category_id" = 1)
             ORDER BY "reviews"."created_at" DESC)
              subquery_for_count

  SELECT DISTINCT "reviews".* FROM "reviews" LEFT OUTER JOIN "products" ON "products"."id" = "reviews"."product_id" LEFT OUTER JOIN "brands" ON "brands"."id" = "products"."brand_id"
   WHERE (((((("reviews"."title" ILIKE '%webp%' OR "reviews"."body" ILIKE '%webp%')
    OR "products"."name" ILIKE '%webp%')
     OR "reviews"."paper" ILIKE '%webp%')
      OR "reviews"."pen" ILIKE '%webp%')
       OR "brands"."name" ILIKE '%webp%')
        AND 
        ((((("reviews"."title" ILIKE '%オリジナル%' OR "reviews"."body" ILIKE '%オリジナル%')
         OR "products"."name" ILIKE '%オリジナル%')
          OR "reviews"."paper" ILIKE '%オリジナル%')
           OR "reviews"."pen" ILIKE '%オリジナル%')
            OR "brands"."name" ILIKE '%オリジナル%')
             AND
              "products"."category_id" = 1)
               ORDER BY "reviews"."created_at" DESC
```
グループ分けされたワードごとに指定したカラムをORで検索して、その結果をAND検索してます。

これで、すべての検索ワードがいずれかのカラムに含まれているもののみを結果として返してくれます。

上記クエリの結果は以下の通りです。
[![Image from Gyazo](https://i.gyazo.com/721be84b373e5fc0d040b0bf913a9e0a.png)](https://gyazo.com/721be84b373e5fc0d040b0bf913a9e0a)

やっと複数ワードAND検索ができました。

明日からは初期データ入れてMVPリリース目指します。

