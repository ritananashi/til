※スクール内timesの移植（2025/09/16）

リサイズはできる…けどwebp変換をconvertでやるとファイルないよって言われる…  
正確には`新しいレコードのsigned_idを取得できない`っていわれる  
CarrierWaveだと設定ファイルに書くだけなんだけどな～～～～  
リサイズはできるの…。  

urlはwebpになった  
添付画像の詳細ってどう調べるんだ  
手っ取り早く保存してプロパティ見たら項目の種類webpになってるけどだいじょぶそ？  

- 学習時間：6h/6h/792h
- 学習内容：卒制

ActiveStorageで画像をアップロードする前にリサイズしてwebp形式に変換してから保存する実装をしてました。  
`attach`でやろうとしたけど画像ないよって言われるので結局`review_params`を直接いじる方向にいきました。  
画像のリサイズはできたけど、`ImageProcessing`の`convert`を使ってwebpに変換しようとしても`新しいレコードのsigned_idを取得できない`と言われましたが、バリデーションでwebp形式も許可出したら許されました。  
ただ、`convert`だけだとwebpに変換してもファイル名の拡張子と`content_type`がアップロードされた画像から読み取れるもののままなせいで実質webpに変換できていない…というような事態になっていたので、`original_filename`の拡張子以外の部分を取得してから`.webp`とがっちゃんこして、`content_type`も`image/webp`で上書きして、ようやくwebp形式にできました。  
ところで`convert`いるのか？と思ったので実験してみました。  
`convert`なしで`logger.debug`を仕込んでみてみます。  
[![Image from Gyazo](https://i.gyazo.com/84386ab8f71adc08600b06a1e8cb6d2a.png)](https://gyazo.com/84386ab8f71adc08600b06a1e8cb6d2a)  
`original_filename`と`content_type`は変わってますが、tempfile自体はJPEGのままですね（あたりまえ）  
保存してみてプロパティで詳細を見てみましたが画像サイズは99.5KBでした。  
今度は`convert`あり  
[![Image from Gyazo](https://i.gyazo.com/11db03efdd23411d8379e1850a16edb0.png)](https://gyazo.com/11db03efdd23411d8379e1850a16edb0)  
`tenpfile`の拡張子もwebpに変わってますね。  
プロパティでは85.1KBでした。  
サイズのみ変更した同じ画像のJPEGファイルのサイズがconvertなしの時と同じ99.5KBだったので、webp形式のほうがJPEGよりも圧縮率が高いことを考えると、`convert`なしのほうは内部的にはJPEGのままなのでは？と思ってます。  
ただ、ちょっと見づらいかもなんですけど  
[![Image from Gyazo](https://i.gyazo.com/80938fc2ba88e8b3e818bcf5ac7fa420.png)](https://gyazo.com/80938fc2ba88e8b3e818bcf5ac7fa420)  
最終的に添付された全データを見ると、`@headers`の情報はJPEGのままなんですよね…。  
`convert`は画像を書き込む際に基のフォーマットが保持されるので、これかな…。でも元のフォーマットを保持しないで変換するやり方はなさそう…。  
上手く調べられなかったのでアップロードされたファイルの詳細情報調べられる方法あるのかな…。なんかうまく調べられなくて…。  
上手いこといっているのかどうかわかりませんが、とりあえずこのまま進みつつ、情報収集していきます。

