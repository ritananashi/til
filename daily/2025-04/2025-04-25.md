※スクール内timesの移植（2025/09/16）

- 学習時間：5h/26h30min/847h
- 学習内容：卒制

# Switch2落選しました
ちくしょー！と思いつつ、まあできることしましょうねってことで応募できる抽選に片っ端から応募してました。  
GEOも応募できるけど、店頭に行ってレンタル機能を付与してもらわないとだったので、午前中はGEOに行ってました。  
ライドウリマスターが発売する6月19日までにゲットが目標です。できるんか？やります。  
ライドウリマスターのSwitch2版ファミ通DXエディションブライトアーツセットは…予約開始に気づくのが遅くて…予約できなかったので…。  
でも特典は欲しいからSwitch版予約のままにします…。  

家に帰ってからはAdministrateと格闘してました。  
先達の記事が全然ねえ！ので、公式GitHubのissueを探したりしながらなんとかやってます。  
デフォルトでActiveStorageをサポートしていないので、[administrate-field-active\_storage](https://github.com/Dreamersoul/administrate-field-active_storage)を導入したりなどしてました。  
これもissue見たらAdministrateのver1.0.0に向けて公式でサポートしません？みたいな話が出てるっぽいので、Administrateのver1.0.0が出たらサポートされてるかもです。  
でもまあ今はサポートされてないからね…gemいれるね…。  
Administrateがデフォルトで生成してくれるActiveStorageとの関連名は`modelに設定した関連付け名_attachment`みたいな感じになっていて、さらにblobとの関連が`modelに設定した関連付け名_blob`として生成されているので、まずここをどうすりゃいいの？から始まりました。  
READMEだと
```
class ModelDashboard < Administrate::BaseDashboard
  ATTRIBUTE_TYPES = {
    attachment: Field::ActiveStorage,
  }
```
のように記述するようでしたが、blobの部分についての記載がないので、適当にblobでissueを検索かけてみました。  
[ActiveStorage fieldを追加するとエラーがでるんだけど](https://github.com/Dreamersoul/administrate-field-active_storage/issues/20)みたいな内容のissueに、[より詳細なサンプルコード](https://github.com/Dreamersoul/administrate-field-active_storage/issues/20#issuecomment-511743146)が載っていました。  
`modelに設定した関連付け名_attachment`はREADME通り`モデルに設定した関連付け名`に直しちゃってよくて、`modelに設定した関連付け名_blob`の項目は消しちゃっていいみたいです。  
とりあえずこれでエラーなく添付画像が表示できるようになりました。やったね。  
あと、管理画面で添付画像も消せるようにできるみたいなので、それもやってみてました。  
READMEには、ルートの設定とコントローラにメソッドを定義すると書かれていたので、まずはREADME通りにやりました。
```
# routes.rb
...
namespace :admin do
  ...
  resources :users do
    delete :avatars, on: :member, action: :destroy_avatar
  end
end

# app/controllers/admin/users_controller.rb
module Admin
  class UsersController < ApplicationController

    # For illustrative purposes only.
    #
    # **SECURITY NOTICE**: first verify whether current user is authorized to perform the action.
    def destroy_avatar
      avatar = requested_resource.avatars.find(params[:attachment_id])
      avatar.purge
      redirect_back(fallback_location: requested_resource)
    end
  end
end
```
で、ここから迷ったところ。  
上記の記述をするだけでは削除ボタンは出てきません。当たり前！  
おそらくこれだろうなという記述はありましたが、ルートのカスタマイズと一緒に書かれているのでいまいち確証が持てません。
```
# routes.rb
delete :custom_user_avatar_destroy, to: 'users#destroy_avatar'

# user_dashboard.rb
class UserDashboard < Administrate::BaseDashboard
  ATTRIBUTE_TYPES = {
    avatars: Field::ActiveStorage.with_options(
      destroy_url: proc do |namespace, resource, attachment|
        [:custom_user_avatar_destroy, { attachment_id: attachment.id }]
      end
    ),
    # ...
  end
  # ...
end
```
ええいこいつも検索じゃ！！いまいちわかりづらいREADMEだから誰か質問してるだろ！！！  
あったわ　→　[Delete button](https://github.com/Dreamersoul/administrate-field-active_storage/issues/77)  
やっぱりこれだろうなと思ってた部分でよかったみたいです。  
その後にでた`No route matches`エラーについてもissueに載ってました。よかった。  
今は一覧画面に出ちゃってる削除ボタンを消そうと思って`app/views/fields/active_storage/_item.html.erb`の生成方法を調べてたところです。特に生成できるコマンドないみたい…。そうなんだ…。  
viewsにadmin/fields/active_storage/_item.html.erbを生成してコピペしてオーバーライドしかないかな。

