※スクール内timesの移植（2025/09/16）


- 学習時間：4h30min/8h/768h
- 学習内容：卒制（本リリースissue作成）+ 就活シート記入（途中！）
  

質問の回答を待っている間に就活シートを書こう！と思ってやっていたのですが、途中で具合が悪くなって休憩してました。

季節の変わり目！天気が悪い！！影響を受けちゃいましたね…。

ちょっと回復した後は、体が動くうちにやっておいて（回答の内容がなんであれ）今日中に本リリースのissueの修正を提出できるようにしなければ…！と思ってissueの修正をしてました。

追加で提案された機能（トランザクション対応、画像アップロード前に画像を加工）について調べていました。
  

トランザクション対応は、create、uploadはいいんですけど、destroyが「ロールバックが発生すると、既に消されてしまっている画像の実体は復元できないので画像が表示できない」ということになるよなーと思って調べてました。

ここでちょっと前に苦しめられた`nilで上書きすると画像が消える`と再び出会うことになるとは…　→　[Rails: ActiveStorageでファイルを削除するときは、単にnilで更新するだけでいい](https://techracho.bpsinc.jp/konaga/2023_08_22/133768)

`detach`を使う方法（[ActiveRecord トランザクションと ActiveStorage をちょっとだけ仲良くさせる方法](https://tech.smarthr.jp/entry/2018/09/14/130139)）もあり、どっちがいいかなーと思いましたが、大量のレコードを一度に削除するようなことってたぶんないので、トランザクションの末尾（destroyの後くらい）か外で`purge`するか、`purge_later`を使うかで良い気がしました。
  

画像をS3にアップロード前に加工して保存、についてはActiveStorageで調べると`variant`についての記事がたくさん出てきてちょっと困りました。

`variant`は元画像を加工したものを生成してS3に保存して使う、なので「元画像を保存前に加工してから保存したい」時とは違うんですよね。

ただ、[Railsガイド](https://railsguides.jp/active_storage_overview.html)とかでも画像の加工についでは`variant`を使う記述しか載ってないので、そもそも「元画像を加工してから保存する」こととかは考えていないのかも、と思いました。

そこはそれとして2本くらい記事は見つけたのと、「そもそもparamsで受け取ったimagesを加工してから`images.attach`の引数に渡せばいいのでは？」と思ったので、issueに取り掛かるときに試してみます。試してガッテン。
