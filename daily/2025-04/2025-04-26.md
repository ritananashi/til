※スクール内timesの移植（2025/09/16）

- 学習時間：7h/33h30min/854h
- 学習内容：卒制 + 就活準備 + イベント参加

Runteq.rb聞きながら就活のもろもろ書いたりAdministrateと格闘したりしてました。  
ためになるお話がたくさんで楽しかったです。デバッグと仲良くならないとなあと思いました。  
やまさかなさんのgem入れるか…。  

今日も今日とてAdministrateと格闘してました。  
画像削除のビューは`app/views/admin/fields/active_storage/_item.html.erb`じゃなくて`app/views/fields/active_storage/_item.html.erb`でオーバーライドできました。やったぜ。  
添付は問題なくできたので削除をお試し…と思ったら、Userが見つからないエラーが出てなぜ！？としてました。  
私はRailsの`to_param`メソッドをオーバーライドして、User関連のURLにIDじゃなく`account`カラムに登録された文字列を表示するように設定していて、Administrateはデフォルトで`id`を検索するけどURLは`account`なので、検索のメソッドをオーバーライドして`account`を検索するように変更していました。  
なので、アカウントを探させるときは`account`の値を渡してあげないといけないのですが…。  
昨日実装してたこのコード
```
# user_controller.rb
def destroy_avatar
      avatar = requested_resource.avatar # has_oneのときはこれ
      avatar.purge
      redirect_back(fallback_location: requested_resource)
    end

# user_dashboard.rb
class UserDashboard < Administrate::BaseDashboard
  ATTRIBUTE_TYPES = {
    avatar: Field::ActiveStorage.with_options(
      destroy_url: proc do |namespace, resource, attachment|
        [:avatar_admin_user, { attachment_id: attachment.id }]
      end
    ),
    # ...
  end
  # ...
end
```
これだけだとエラーが出るので、公式issueに載ってた対応を追加したコードがこちらです。
```
avatar: Field::ActiveStorage.with_options(
      destroy_url: proc do |namespace, resource, attachment|
        [:avatar_admin_user, { id: resource.id, attachment_id: attachment.id }]
      end
    ),
```
`resource.id`でユーザーIDを渡してあげないとエラーになるようなので渡してあげてます。  
勘のいいひとはもうこれでユーザーが探せなかった原因がわかると思います。  
そうです。**ここで渡すべきは`id`ではなく`account`です。**  
ここに気づくまでにちょっと時間がかかりました。  
`requested_resource`はAdministrateのメソッドで、内部で`find_resource(params[:id])`をしています。  
`find_resource(params[:id])`はAdministrateのメソッドで`find`メソッドでユーザーを探すメソッドです。  
わたしはこの`find_resource(params[:id])`をオーバーライドして、`find_by!(account: param)`を実行するようにしています。  
なので、IDを渡しても検索できないんですね。  
ここに気づいて、やっと画像削除ができました。やったぜ。  
あとはupdataの時に画像加工するやつをこっちにも実装したりしました。  
今悩んでるのは**管理画面でユーザー作成をできるようにするかどうか**です。  
デフォルトの機能としてユーザー作成機能が作成されてはいますが、Deviseのコントローラを使っていないので、そのままだとユーザー登録できません。  
Deviseの`password`を使えば行けるかな？とは思いますが、そもそも機能としているのか？というのがあり…。  
明日は定期お休み日なので、ちょっと考えてます。

