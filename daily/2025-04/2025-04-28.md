※スクール内timesの移植（2025/09/16）


Railsのfile_fieldでmultiple: trueの時に添付なしでupdateすると画像が消える問題、[administrate-field-active\_storage](https://github.com/Dreamersoul/administrate-field-active_storage)公式だと回避用のモジュール作ってモデルに読み込ませてるけど、`_form.html.erb`のfile_fieldに`include_hidden: false`指定すれば行けるのでは？

こっちをオーバーライドしてみてだめだったらモジュール作ろ。

`file_field_options`はダイレクトアップロードとhas_manyにしか対応してなさそーやっぱービューファイルをいじる方がいいかな…。

うーん、ビューファイルいじってもだめそう

lib/administrate/field/active_storage.rbをオーバーライドするんじゃだめかなー？

公式の回避策、adminじゃないモデルファイルにモジュール読み込ませるから既存の実装に影響でたらちょっとイヤ

お？うまくいった？？？

上手くいった！file_field_optionsの指定の仕方を勘違いしてただけだった！`file_field_options: { include_hidden: false }`を`with_options`の引数に渡せばhidden_field消えた！！！

よし編集しても画像消えない！大丈夫だな！！

誰ですか公式のREADMEから`file_field_options`の書き方消した人


- 学習時間：6h/6h/860h
- 学習内容：卒制
  

Administrateの管理画面からユーザー登録できるようになりました。

思った通り、Deviseの`password`メソッドを使ったら`encrypted_password`カラムにハッシュ化されたパスワードを保存できました。

うっかり`requested_resource.password`と書いてしまったがためにユーザー見つからないよエラーが出てしまい、ここに気づくのにちょっと時間かかったというダメっぷりも発揮しましたが、実装できてよかったなあと思いました。
  

次にレビューの管理画面をいじってました。

といってもだいたいのことはユーザー管理画面いじってた時にわかったので、あんまり時間かからないかなー？と思いましたが、伏兵がいました。

そうです。`hidden_field`です。

Railsの`file_field`はmultiple: trueを指定したときに、一緒に`file_field`と同じ名前の`hidden_field`を作成します。

このために、multiple: true指定時に、画像の添付なしでupdateすると、`hidden_field`の空文字が送信されてしまい、もともと添付されてた画像が消されてしまいます。

最近[Railsガイド](https://railsguides.jp/active_storage_overview.html#%E6%B7%BB%E4%BB%98%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88vs%E8%BF%BD%E5%8A%A0)を読み返していて気づいたのですが、`form.hidden_field`で各添付ファイルの`signed_id`を指定すると全部上書きじゃなくていらないやつだけ消して残した画像を維持したまま新しく追加できる、ようなのでもしやこのためか！？と思いましたが、valueの指定ができないから違うかも。

話を戻して、multiple: true指定だけだとupdateの時に画像が消えてしまうので、`file_field`に`include_hidden: false`も指定する必要があります。これを指定すれば、`hidden_field`が消えてくれます。

なので、`include_hidden: false`を指定したいのですが…ビューファイルのオーバーライドだとエラーが出てしまい、ダメでした。

公式の回避策も[公式のREADME](https://github.com/Dreamersoul/administrate-field-active_storage)に書いてありますが、`モジュールを作成して、モデルファイルにincludeする`というやり方なので、既に`include_hidden: false`を指定して対応しているadminじゃない方の実装に影響が出たらいやだなと思い、別の方法を探ってました。

公式のREADMEだと`file_field_options`というオプションを指定できるようです。
> The file_field_options is a configuration option that allows you to customize the behavior and appearance of the file input field used for uploading attachments. You can pass various options to file_field to control its functionality.
The multiple HTML attribute for file input fields is set by default based on ::ActiveStorage::Attached::Many, but can be overridden through this option. The direct attribute to enable direct uploads is set to read from the field options, but can be overridden through this option.
file_field_optionsは、添付ファイルのアップロードに使われるファイル入力フィールドの動作と外観をカスタマイズできる設定オプションです。file_fieldに様々なオプションを渡して、その機能を制御することができます。
ファイル入力フィールドのmultiple HTML属性はデフォルトでは::ActiveStorage::Attached::Manyに基づいて設定されますが、このオプションで上書きすることができます。直接アップロードを可能にする direct 属性はフィールドオプションから読み込むように設定されていますが、このオプションで上書きすることができます。
  

ということは、ここに`include_hidden: false`を指定すればいけるのでは？と思ったのですが、記載方法がわからず…。

`direct_upload`とかはそのまま`with_option`に渡すようなので、`include_hidden: false`を渡してみましたがだめで、lib/administrate/field/active_storage.rbを見てみたらダイレクトアップロードとhas_manyしか記載なさそう？だったので、対応していないのかなと思い、lib/administrate/field/active_storage.rbをオーバーライドすれば…？と考えてました。

ですが、`file_field_options`メソッドの`fetch`の第二引数が`{ }`になっていること、`file_field_options`が追加されたプルリクのREADMEには**`file_field_options: { direct: true }`で設定する**と記述があったことから、`file_field_options: { include_hidden: false }`で指定してみたところ、`hidden_field`が消えてくれました。 :yeiyei: 

なぜか最新版のREADMEからは記述が消えてしまっていて、ずいぶん回り道をしましたが…なんとかなってよかったです。

