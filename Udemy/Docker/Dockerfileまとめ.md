
# Dockerfile  
DockerfileはDockerイメージをコード化したもの。  
`docker build`を使うことでDockerfileからDockerイメージを作ることができる。  
Dockerfileを読むと一目でインフラ構成がどうなっているかがわかる。  
自分のオリジナルにカスタマイズしたイメージを簡単に作ることもできる。  
コンテナで立ち上げたソフトの設定はあまり変えることができないが、Dockerfileを使うと設定を変えられる。  
→自分の用途に合わせたDockerイメージを作ることができる！  
Dockerfileは
```  dockerfile
FROM nginx:1.16
# ベースのDockerイメージ
RUN apt install -y
# アップデート
COPY source /var/www/html
# ソースコードのコピー
EXPOSE 8080
# ポートを開ける
```
のように記述する。

# Dockerfileのベストプラクティス  
[詳しくはDocker-docs-jaを参照](https://docs.docker.jp/develop/develop-images/dockerfile_best-practices.html)  
※動画中のURLは古いURL。最新はこっち↑  

- 一時的なコンテナを作成（旧：コンテナはエフェメラルであるべき）  
  エフェメラル＝状態を持たない。  
  コンテナ1個１個が別々のデータを持って、常に変動するような動きはやめるべき。  
  ボリュームを共有することで、コンテナが壊れても新しく立ち上げたコンテナも最新のデータになっている。  
  コンテナはどれだけ破壊されてもOKであるべき。  
  コンテナ1個1個が状態を持つようなDockerfileにしない。  
- .dockerignoreで除外  
  ビルドの時に除外するファイルを指定するファイル。  
  そもそも余計なファイルを書かないようにする。  
- 不要なパッケージのインストール禁止
  コンテナは最小単位で極力シンプルなものにするような構築方法が推奨されている。
  コンテナの中にあるプロセス（アプリ）に不要なものは極力インストールしないで、最小限のインストールだけですませる。
- アプリケーションを切り離す（旧：コンテナ毎に１つのプロセスだけ実行）
  webアプリを作ろうとしたら、webサーバー、アプリケーションサーバー、データベースサーバー、キャッシュサーバーのように複数のプロセスが必要になるが、その際も一つのコンテナにまとめるのではなく、複数のコンテナで分けて立ち上げてコンテナを連携させる。
  Dockerfileを作るときも、一つだけのプロセスを入れるようにする。
- レイヤの数を最小に  
  レイヤーが多いと読みづらくなるし、ビルドに時間がかかってしまうので、極力レイヤーの数は最小限にする。
- 複数行にわたる引数は並びを適切に（旧：複数行の引数）  
  複数行記述するときは'\'で改行すると読みやすい。

# Dockerfile書き方
- RUNとCMD  
  どちらもLinuxのコマンドを実行するけど、実行タイミングが異なる。  
  RUNは**Dockerfile　→　イメージ**  
  CMDは**イメージ　→　コンテナ**  

  CMDはexec形式での記述が推奨されている。  
  Jsonの配列形式で記述するので、必ずコマンドを`""（ダブルクオーテーション）`で囲む。`''（シングルクオーテーション）`だとコマンドとして認識されない。  
  参考：[docker-docs-ja - dockerfileリファレンス - CMD](https://docs.docker.jp/engine/reference/builder.html#cmd)

  ```Dockerfile
  FROM ubuntu:20.04
  # ベースイメージ：ubuntuのVer20.04
  RUN apt-get update -y && \
  # パッケージのアップデート。&&はレイヤーをひとつにまとめるコマンド。
    apt-get install -y nginx
  # nginxのインストール。ここまでがdocker build時に実行されてイメージになる。
  CMD["nginx","-g","demon off;"]
  # RUNコマンドで作られたイメージからコンテナを立ち上げる。demon offはnginxをフォアグラウンドで稼働させるコマンド。
  ```
  ```Dockerfile
  ...
  RUN apt-get update -y
  RUN apt-get install -y nginx
  # RUNコマンドはこう書いてもいいが、RUNが2個あるので、レイヤーが2つ作られてしまう。
  # 動画では、updateとinstallは似たコマンドなので&&で一つのレイヤーにまとめて
  # レイヤーイメージの縮小を図るとのこと。
  # \で改行になる。
  ```
  - `decker build -t`でイメージに名前を付けられる。
  - `docker run -d`でバックグラウンド起動。
- COPYとADDコマンド  
  どちらもファイルをイメージに追加する命令。  
  ADDはネット経由からもファイルをダウンロードできたり、tar/zipみたいな圧縮ファイルでも追加できる。  
  Docker公式はCOPYを推奨しているので、ADDよりCOPYを使った方がいい。  
  機能が絞られていた方が間違いがないし、基本的にホストのファイルを追加するだけで十分なことができる。  
  ```Dockerfile
  COPY ホストのファイル コンテナのパス
  # docker buildでホストのファイルが指定したコンテナのパスの中に入る。
  ```
  COPYの使いどころ
  - イメージにプログラムのソースコードを入れたいとき
  - 設定ファイルをあらかじめソフトのほうに入れておいて、設定ファイルが反映された状態でイメージを作りたいとき
- ENV  
  環境変数を設定するコマンド。  
  DockerfileがDockerイメージにbuildされるタイミングで環境変数を決めておける。  
  - DBのユーザー名
  - 動作環境（localとかproductionとか） 
  等によく使う。
  ENVは直接書き込みなので固定値になってしまうから、環境によって環境変数の値を出し分けたいときには使えない。
  ```dockerfile
  ENV TESTENV=testvalue
  # キー＝バリューで書く。なんでもいい。
  ENV APP_ENV="production"
  # アプリの環境についての設定。よく使う？らしい。
  # 複数設定できるので並べて書いていい。
  ENV key value
  # こういう書き方もある。
  ```
